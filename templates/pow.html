{% extends "base.html" %}

{% block title %}PoW æŒ–çŸ¿æ¨¡æ‹Ÿå™¨ - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">â›ï¸ å·¥ä½œé‡è¯æ˜æ¨¡æ‹Ÿå™¨</h1>
    <p class="page-subtitle">å¯»æ‰¾æ»¡è¶³éš¾åº¦ç›®æ ‡çš„ Nonce - ä½“éªŒæŒ–çŸ¿çš„æ ¸å¿ƒåŸç†</p>
</div>

<div class="tool-layout">
    <div class="panel">
        <h2 class="panel-title">ğŸ“ æŒ–çŸ¿å‚æ•°</h2>

        <div class="input-group">
            <label class="input-label">åŒºå—æ•°æ®ï¼ˆæ¨¡æ‹ŸåŒºå—å¤´ï¼‰</label>
            <input type="text" id="blockData" class="input-field"
                value="Block #100 | PrevHash: 000abc | Tx: Alice->Bob 1 BTC" placeholder="è¾“å…¥åŒºå—æ•°æ®">
        </div>

        <div class="input-group">
            <label class="input-label">éš¾åº¦ï¼ˆå‰å¯¼é›¶ä¸ªæ•°ï¼‰</label>
            <input type="range" id="difficulty" min="1" max="6" value="4" style="width: 100%;"
                oninput="updateDiffLabel()">
            <div style="display: flex; justify-content: space-between; color: var(--text-muted); font-size: 0.8rem;">
                <span>1 (ç®€å•)</span>
                <span id="diffLabel">å½“å‰: 4</span>
                <span>6 (å›°éš¾)</span>
            </div>
        </div>

        <button class="btn btn-primary" onclick="startMining()" id="mineBtn">
            â›ï¸ å¼€å§‹æŒ–çŸ¿
        </button>

        <div class="message info" style="margin-top: 1.5rem;">
            ğŸ’¡ éš¾åº¦æ¯å¢åŠ 1ï¼Œé¢„æœŸæ—¶é—´å¢é•¿çº¦16å€ï¼ˆåå…­è¿›åˆ¶ï¼‰
        </div>

        <div class="result-box" style="margin-top: 1rem;">
            <div class="result-label">éš¾åº¦å¯¹æ¯”ï¼ˆç†è®ºé¢„æœŸå°è¯•æ¬¡æ•°ï¼‰</div>
            <div style="margin-top: 0.5rem; font-size: 0.85rem;">
                <div>éš¾åº¦ 1: ~16 æ¬¡</div>
                <div>éš¾åº¦ 2: ~256 æ¬¡</div>
                <div>éš¾åº¦ 3: ~4,096 æ¬¡</div>
                <div>éš¾åº¦ 4: ~65,536 æ¬¡</div>
                <div>éš¾åº¦ 5: ~1,048,576 æ¬¡</div>
                <div>éš¾åº¦ 6: ~16,777,216 æ¬¡</div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2 class="panel-title">ğŸ“Š æŒ–çŸ¿ç»“æœ</h2>

        <div id="miningProgress" style="display: none;">
            <div class="message info loading">
                â³ æ­£åœ¨æŒ–çŸ¿ä¸­...
            </div>
        </div>

        <div id="results" style="display: none;">
            <div id="resultStatus"></div>

            <div class="stats-grid" style="margin-top: 1rem;">
                <div class="stat-item">
                    <div class="stat-value" id="resultNonce">0</div>
                    <div class="stat-label">æ‰¾åˆ°çš„ Nonce</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="resultAttempts">0</div>
                    <div class="stat-label">å°è¯•æ¬¡æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="resultTime">0</div>
                    <div class="stat-label">è€—æ—¶ï¼ˆç§’ï¼‰</div>
                </div>
            </div>

            <div class="result-box" style="margin-top: 1.5rem;">
                <div class="result-label">ç¬¦åˆæ¡ä»¶çš„å“ˆå¸Œ</div>
                <div class="result-value" id="resultHash" style="font-size: 0.8rem;"></div>
            </div>

            <div class="result-box">
                <div class="result-label">éªŒè¯ä¸å¯¹ç§°æ€§</div>
                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                    <div>æ±‚è§£è€—æ—¶: <span id="solveTime">-</span></div>
                    <div>éªŒè¯è€—æ—¶: <span style="color: var(--accent-green);">&lt;1ms</span></div>
                </div>
            </div>
        </div>

        <div id="placeholder" class="message info">
            ğŸ‘† è®¾ç½®å‚æ•°å¹¶ç‚¹å‡»"å¼€å§‹æŒ–çŸ¿"
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function updateDiffLabel() {
        const diff = document.getElementById('difficulty').value;
        document.getElementById('diffLabel').textContent = 'å½“å‰: ' + diff;
    }

    async function startMining() {
        const data = document.getElementById('blockData').value;
        const difficulty = parseInt(document.getElementById('difficulty').value);

        document.getElementById('miningProgress').style.display = 'block';
        document.getElementById('results').style.display = 'none';
        document.getElementById('placeholder').style.display = 'none';
        document.getElementById('mineBtn').disabled = true;

        try {
            const response = await fetch('/api/pow/mine', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data, difficulty })
            });

            const result = await response.json();

            document.getElementById('miningProgress').style.display = 'none';
            document.getElementById('results').style.display = 'block';

            if (result.success) {
                document.getElementById('resultStatus').innerHTML = `
                <div class="validation-status valid">
                    âœ… æŒ–çŸ¿æˆåŠŸï¼æ‰¾åˆ°æœ‰æ•ˆ Nonce
                </div>`;
                document.getElementById('resultNonce').textContent = result.nonce.toLocaleString();
                document.getElementById('resultHash').textContent = result.hash;
            } else {
                document.getElementById('resultStatus').innerHTML = `
                <div class="validation-status invalid">
                    âŒ æœªèƒ½åœ¨é™å®šæ¬¡æ•°å†…æ‰¾åˆ°æœ‰æ•ˆ Nonce
                </div>`;
                document.getElementById('resultNonce').textContent = '-';
                document.getElementById('resultHash').textContent = 'æœªæ‰¾åˆ°';
            }

            document.getElementById('resultAttempts').textContent = result.attempts.toLocaleString();
            document.getElementById('resultTime').textContent = result.time_seconds;
            document.getElementById('solveTime').textContent = result.time_seconds + 's';

        } catch (error) {
            alert('æŒ–çŸ¿å¤±è´¥: ' + error.message);
        }

        document.getElementById('mineBtn').disabled = false;
    }
</script>
{% endblock %}
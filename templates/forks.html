{% extends "base.html" %}

{% block title %}åˆ†å‰ç›‘æ§å™¨ - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ”€ åˆ†å‰/å­¤å—ç›‘æ§å™¨</h1>
    <p class="page-subtitle">ç†è§£ç¡®è®¤æ•°çš„å®‰å…¨æ€§ - ä¸ºä»€ä¹ˆäº¤æ˜“æ‰€è¦æ±‚6ä¸ªç¡®è®¤ï¼Ÿ</p>
</div>

<div class="tool-layout">
    <div class="panel">
        <h2 class="panel-title">ğŸ”’ ç¡®è®¤æ•°å®‰å…¨ç­‰çº§</h2>

        <div class="input-group">
            <label class="input-label">è¾“å…¥ç¡®è®¤æ•°</label>
            <input type="number" id="confirmations" class="input-field" value="6" min="0" max="100">
        </div>

        <button class="btn btn-primary" onclick="checkSafety()" style="width: 100%;">
            ğŸ” æŸ¥çœ‹å®‰å…¨ç­‰çº§
        </button>

        <div id="safetyResult" style="margin-top: 1.5rem;"></div>

        <hr style="border-color: var(--border-color); margin: 1.5rem 0;">

        <h3 class="panel-title" style="margin-top: 0;">ğŸ“Š å¿«é€Ÿå¯¹æ¯”</h3>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="checkQuick(0)">0ç¡®è®¤</button>
            <button class="btn btn-secondary" onclick="checkQuick(1)">1ç¡®è®¤</button>
            <button class="btn btn-secondary" onclick="checkQuick(3)">3ç¡®è®¤</button>
            <button class="btn btn-secondary" onclick="checkQuick(6)">6ç¡®è®¤</button>
            <button class="btn btn-secondary" onclick="checkQuick(12)">12ç¡®è®¤</button>
        </div>
    </div>

    <div class="panel">
        <h2 class="panel-title">ğŸ“š ä¸ºä»€ä¹ˆè¦6ä¸ªç¡®è®¤ï¼Ÿ</h2>

        <div id="explanation"></div>

        <div class="result-box" style="margin-top: 1.5rem;">
            <div class="result-label">æ”»å‡»æˆæœ¬ä¼°ç®—ï¼ˆé‡å†™6ä¸ªåŒºå—ï¼‰</div>
            <div id="attackCost" style="margin-top: 0.5rem;"></div>
        </div>

        <div class="message info" style="margin-top: 1rem;">
            <strong>åˆ†å‰ç¤ºæ„å›¾ï¼š</strong>
            <pre style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--text-secondary);">
ä¸»é“¾: [N] â†’ [N+1] â†’ [N+2] â†’ [N+3] â†’ ...
                â†“
           [å­¤å—] â† è¢«æŠ›å¼ƒçš„åˆ†å‰
            </pre>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function checkSafety() {
        const confirmations = parseInt(document.getElementById('confirmations').value);

        const response = await fetch('/api/forks/safety?confirmations=' + confirmations);
        const data = await response.json();

        document.getElementById('safetyResult').innerHTML = `
        <div class="result-box">
            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">${data.security_level}</div>
            <div style="color: var(--text-secondary);">${data.description}</div>
            <div style="margin-top: 1rem;">
                <div>æ¨èç”¨äº: <strong>${data.recommended_for}</strong></div>
                <div>é‡ç»„æ¦‚ç‡: <span style="color: var(--accent-orange);">${data.reorg_probability}</span></div>
                <div>ç­‰å¾…æ—¶é—´: ~${data.wait_time_minutes} åˆ†é’Ÿ</div>
            </div>
        </div>`;
    }

    function checkQuick(conf) {
        document.getElementById('confirmations').value = conf;
        checkSafety();
    }

    async function loadExplanation() {
        const response = await fetch('/api/forks/explain');
        const data = await response.json();

        let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
        data.explanation.forEach((item, index) => {
            html += `
            <div class="flow-step">
                <div class="step-number">${index + 1}</div>
                <div class="step-content">
                    <div class="step-title">${item.point}</div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">${item.detail}</div>
                </div>
            </div>`;
        });
        html += '</div>';

        document.getElementById('explanation').innerHTML = html;

        const cost = data.attack_cost;
        document.getElementById('attackCost').innerHTML = `
        <div>æ‰€éœ€ç®—åŠ›: ${cost.required_hashrate}</div>
        <div>æ‰€éœ€åŠŸç‡: ${cost.required_power}</div>
        <div>ç”µåŠ›æˆæœ¬: ${cost.electricity_cost}</div>
        <div>æœºä¼šæˆæœ¬: ${cost.opportunity_cost}</div>
        <div style="margin-top: 0.5rem; color: var(--accent-red); font-weight: bold;">
            æœ€ä½æ€»æˆæœ¬: ${cost.total_minimum_cost}
        </div>`;
    }

    // é¡µé¢åŠ è½½æ—¶è·å–è§£é‡Š
    loadExplanation();
    checkSafety();
</script>
{% endblock %}
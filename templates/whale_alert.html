{% extends "base.html" %}

{% block title %}å·¨é²¸è­¦æŠ¥ - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ‹ å·¨é²¸è­¦æŠ¥ç›‘æ§å™¨</h1>
    <p class="page-subtitle">ç›‘æ§æ¯”ç‰¹å¸é“¾ä¸Šå¤§é¢è½¬è´¦ - è¿½è¸ªå·¨é²¸åŠ¨å‘</p>
</div>

<div class="tool-layout">
    <div class="panel">
        <h2 class="panel-title">ğŸ¯ æ‰«æè®¾ç½®</h2>

        <div class="input-group">
            <label class="input-label">BTC é˜ˆå€¼ï¼ˆå¤§äºæ­¤é‡‘é¢è§†ä¸ºå·¨é²¸ï¼‰</label>
            <input type="number" id="threshold" class="input-field" value="100" min="1" max="10000" step="10">
        </div>

        <div class="input-group">
            <label class="input-label">æ‰«æåŒºå—æ•°</label>
            <input type="number" id="blockCount" class="input-field" value="1" min="1" max="5">
        </div>

        <button class="btn btn-primary" onclick="scanWhales()" id="scanBtn" style="width: 100%;">
            ğŸ” æ‰«æå·¨é²¸äº¤æ˜“
        </button>

        <div id="status" style="margin-top: 1rem;"></div>

        <hr style="border-color: var(--border-color); margin: 1.5rem 0;">

        <div class="result-box">
            <div class="result-label">æœ€æ–°åŒºå—</div>
            <div id="latestBlock" style="font-size: 1.2rem; font-weight: bold;">åŠ è½½ä¸­...</div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
            <div class="result-box">
                <div class="result-label">æ‰«æäº¤æ˜“æ•°</div>
                <div id="txCount" style="font-weight: bold;">-</div>
            </div>
            <div class="result-box">
                <div class="result-label">å‘ç°å·¨é²¸</div>
                <div id="whaleCount" style="font-weight: bold; color: var(--accent-orange);">-</div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2 class="panel-title">ğŸš¨ å·¨é²¸è­¦æŠ¥åˆ—è¡¨</h2>
        
        <div id="whaleList">
            <div class="message info">
                ç‚¹å‡»"æ‰«æå·¨é²¸äº¤æ˜“"æŒ‰é’®å¼€å§‹ç›‘æ§
            </div>
        </div>

        <hr style="border-color: var(--border-color); margin: 1.5rem 0;">

        <div class="message info">
            <strong>ğŸ’¡ æŠ•èµ„æ„ä¹‰</strong>
            <p style="margin-top: 0.5rem; color: var(--text-secondary);">
                é“¾ä¸Šå¤§é¢è½¬è´¦å¾€å¾€æ˜¯å¸‚åœºå‰§çƒˆæ³¢åŠ¨çš„å‰å…†ã€‚ä¾‹å¦‚ï¼š
            </p>
            <ul style="margin-top: 0.5rem; color: var(--text-secondary); padding-left: 1.5rem;">
                <li>å¤§æˆ·å……å€¼è¿›äº¤æ˜“æ‰€ â†’ å¯èƒ½å‡†å¤‡å–å‡º</li>
                <li>ä»äº¤æ˜“æ‰€å¤§é¢æç° â†’ å¯èƒ½é•¿æœŸæŒæœ‰</li>
                <li>å·¨é²¸ä¹‹é—´è½¬è´¦ â†’ å¯èƒ½åœºå¤–äº¤æ˜“æˆ–æœºæ„è°ƒä»“</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let isScanning = false;

    async function scanWhales() {
        if (isScanning) return;
        
        isScanning = true;
        const btn = document.getElementById('scanBtn');
        btn.disabled = true;
        btn.textContent = 'â³ æ‰«æä¸­...';
        
        document.getElementById('status').innerHTML = 
            '<div class="message">æ­£åœ¨è¿æ¥åŒºå—é“¾èŠ‚ç‚¹...</div>';

        const threshold = parseFloat(document.getElementById('threshold').value);
        const blockCount = parseInt(document.getElementById('blockCount').value);

        try {
            const response = await fetch('/api/whale/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    threshold_btc: threshold,
                    block_count: blockCount
                })
            });
            const data = await response.json();

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('latestBlock').textContent = 
                `#${data.latest_height?.toLocaleString() || '-'}`;
            document.getElementById('txCount').textContent = 
                data.total_transactions?.toLocaleString() || '-';
            document.getElementById('whaleCount').textContent = 
                data.whale_count || '0';

            // æ˜¾ç¤ºçŠ¶æ€
            let statusClass = data.is_mock ? 'warning' : 'success';
            let statusText = data.is_mock 
                ? 'âš ï¸ ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆAPI æš‚æ—¶ä¸å¯ç”¨ï¼‰' 
                : `âœ… æ‰«æå®Œæˆï¼Œè€—æ—¶ ${data.scan_time_seconds}s`;
            
            document.getElementById('status').innerHTML = 
                `<div class="message ${statusClass}">${statusText}</div>`;

            // æ˜¾ç¤ºå·¨é²¸åˆ—è¡¨
            if (data.whales && data.whales.length > 0) {
                let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
                
                data.whales.forEach((whale, index) => {
                    let emoji = 'ğŸ‹';
                    let bgColor = 'var(--accent-blue)';
                    
                    if (whale.amount_btc >= 1000) {
                        emoji = 'ğŸ‹ğŸ‹ğŸ‹';
                        bgColor = 'var(--accent-red)';
                    } else if (whale.amount_btc >= 500) {
                        emoji = 'ğŸ‹ğŸ‹';
                        bgColor = 'var(--accent-orange)';
                    }
                    
                    html += `
                    <div class="result-box" style="border-left: 4px solid ${bgColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 1.5rem;">${emoji}</span>
                            <span style="font-size: 1.25rem; font-weight: bold; color: ${bgColor};">
                                ${whale.amount_btc.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} BTC
                            </span>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                            <div>äº¤æ˜“å“ˆå¸Œ: ${whale.hash?.substring(0, 24)}...</div>
                            <div>è¾“å…¥: ${whale.inputs_count} | è¾“å‡º: ${whale.outputs_count}</div>
                            <div>åŒºå—: #${whale.block_height?.toLocaleString()}</div>
                        </div>
                    </div>`;
                });
                
                html += '</div>';
                document.getElementById('whaleList').innerHTML = html;
            } else {
                document.getElementById('whaleList').innerHTML = `
                <div class="message">
                    ğŸ” åœ¨é˜ˆå€¼ ${threshold} BTC ä¸‹æœªå‘ç°å·¨é²¸äº¤æ˜“ã€‚<br>
                    <span style="color: var(--text-muted);">å°è¯•é™ä½é˜ˆå€¼æˆ–å¢åŠ æ‰«æåŒºå—æ•°ã€‚</span>
                </div>`;
            }

        } catch (error) {
            document.getElementById('status').innerHTML = 
                `<div class="message error">âŒ æ‰«æå¤±è´¥: ${error.message}</div>`;
        }

        isScanning = false;
        btn.disabled = false;
        btn.textContent = 'ğŸ” æ‰«æå·¨é²¸äº¤æ˜“';
    }

    async function loadLatestBlock() {
        try {
            const response = await fetch('/api/whale/latest');
            const data = await response.json();
            document.getElementById('latestBlock').textContent = 
                `#${data.height?.toLocaleString() || '-'}`;
        } catch (error) {
            document.getElementById('latestBlock').textContent = 'è¿æ¥ä¸­...';
        }
    }

    // é¡µé¢åŠ è½½æ—¶è·å–æœ€æ–°åŒºå—
    loadLatestBlock();
</script>
{% endblock %}

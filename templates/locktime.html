{% extends "base.html" %}

{% block title %}æ—¶é—´é”æ¼”ç¤º - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">â° æ—¶é—´é”äº¤æ˜“æ¼”ç¤º</h1>
    <p class="page-subtitle">nLockTime æœºåˆ¶ - è®©äº¤æ˜“åœ¨æœªæ¥æ‰ç”Ÿæ•ˆ</p>
</div>

<div class="tool-layout">
    <div class="panel">
        <h2 class="panel-title">ğŸ”’ åˆ›å»ºæ—¶é—´é”</h2>

        <div class="input-group">
            <label class="input-label">é”å®šç±»å‹</label>
            <select id="lockType" class="input-field" onchange="updateLockLabel()">
                <option value="blocks">åŒºå—é«˜åº¦é”</option>
                <option value="time">æ—¶é—´æˆ³é”</option>
            </select>
        </div>

        <div class="input-group">
            <label class="input-label" id="lockValueLabel">é”å®šåŒºå—æ•°</label>
            <input type="number" id="lockValue" class="input-field" value="100" min="1">
        </div>

        <button class="btn btn-primary" onclick="createLocktime()" style="width: 100%;">
            ğŸ”’ ç”Ÿæˆæ—¶é—´é”äº¤æ˜“
        </button>

        <div id="locktimeResult" style="margin-top: 1.5rem;"></div>
    </div>

    <div class="panel">
        <h2 class="panel-title">ğŸ“š åº”ç”¨åœºæ™¯</h2>

        <div id="useCases">
            <div class="message">åŠ è½½ä¸­...</div>
        </div>

        <hr style="border-color: var(--border-color); margin: 1.5rem 0;">

        <div class="message info">
            <strong>ğŸ’¡ nLockTime å¦‚ä½•å·¥ä½œ</strong>
            <ul style="margin-top: 0.5rem; color: var(--text-secondary); padding-left: 1.5rem;">
                <li><strong>å€¼ < 5äº¿</strong>ï¼šè§£é‡Šä¸ºåŒºå—é«˜åº¦</li>
                <li><strong>å€¼ â‰¥ 5äº¿</strong>ï¼šè§£é‡Šä¸º Unix æ—¶é—´æˆ³</li>
                <li>äº¤æ˜“åœ¨é”å®šæœŸå†…æ— æ³•è¢«å¹¿æ’­</li>
                <li>sequence å¿…é¡» < 0xFFFFFFFF æ‰èƒ½å¯ç”¨</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function updateLockLabel() {
        const type = document.getElementById('lockType').value;
        const label = document.getElementById('lockValueLabel');
        const input = document.getElementById('lockValue');

        if (type === 'blocks') {
            label.textContent = 'é”å®šåŒºå—æ•°';
            input.value = 100;
        } else {
            label.textContent = 'é”å®šå°æ—¶æ•°';
            input.value = 24;
        }
    }

    async function createLocktime() {
        const lockType = document.getElementById('lockType').value;
        const lockValue = parseInt(document.getElementById('lockValue').value);

        try {
            const response = await fetch('/api/locktime/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lock_type: lockType, lock_value: lockValue })
            });
            const data = await response.json();

            let statusColor = data.explanation.emoji === 'ğŸ”’' ? 'var(--accent-orange)' : 'var(--accent-green)';

            document.getElementById('locktimeResult').innerHTML = `
            <div class="result-box">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 1.5rem;">${data.explanation.emoji}</span>
                    <span style="font-weight: bold; color: ${statusColor};">
                        ${data.explanation.description}
                    </span>
                </div>
                
                <div style="margin-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                    <div>
                        <div class="result-label">å½“å‰åŒºå—</div>
                        <div>#${data.current_block.toLocaleString()}</div>
                    </div>
                    <div>
                        <div class="result-label">LockTime å€¼</div>
                        <div>${data.locktime_value.toLocaleString()}</div>
                    </div>
                </div>
                
                ${data.explanation.blocks_remaining ? `
                <div style="margin-top: 0.75rem;">
                    <div class="result-label">å‰©ä½™åŒºå—</div>
                    <div>${data.explanation.blocks_remaining} åŒºå— (çº¦ ${data.explanation.estimated_minutes} åˆ†é’Ÿ)</div>
                </div>
                ` : ''}
                
                ${data.explanation.unlock_time ? `
                <div style="margin-top: 0.75rem;">
                    <div class="result-label">è§£é”æ—¶é—´</div>
                    <div>${data.explanation.unlock_time}</div>
                </div>
                ` : ''}
                
                <div style="margin-top: 1rem; padding: 0.75rem; background: var(--surface-elevated); border-radius: 8px;">
                    <strong>å¹¿æ’­çŠ¶æ€:</strong> ${data.broadcast_status}
                </div>
            </div>
            
            <div class="result-box" style="margin-top: 1rem;">
                <div class="result-label">æ¨¡æ‹Ÿäº¤æ˜“ç»“æ„</div>
                <pre style="font-size: 0.8rem; margin-top: 0.5rem; overflow-x: auto; color: var(--text-secondary);">${JSON.stringify(data.transaction, null, 2)}</pre>
            </div>`;

        } catch (error) {
            document.getElementById('locktimeResult').innerHTML =
                `<div class="message error">åˆ›å»ºå¤±è´¥: ${error.message}</div>`;
        }
    }

    async function loadUseCases() {
        try {
            const response = await fetch('/api/locktime/usecases');
            const data = await response.json();

            let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';

            data.forEach(useCase => {
                html += `
                <div class="result-box" style="padding: 0.75rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.25rem;">${useCase.emoji}</span>
                        <span style="font-weight: bold;">${useCase.name}</span>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                        ${useCase.description}
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted);">
                        å…¸å‹å‘¨æœŸ: ${useCase.typical_period}
                    </div>
                </div>`;
            });

            html += '</div>';
            document.getElementById('useCases').innerHTML = html;
        } catch (error) {
            document.getElementById('useCases').innerHTML =
                `<div class="message error">åŠ è½½å¤±è´¥</div>`;
        }
    }

    // é¡µé¢åŠ è½½æ—¶
    loadUseCases();
</script>
{% endblock %}
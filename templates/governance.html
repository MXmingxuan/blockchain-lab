{% extends "base.html" %}

{% block title %}æ²»ç†ä¸ç¡¬åˆ†å‰ç›‘æ§ - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ›ï¸ æ²»ç†ä¸ç¡¬åˆ†å‰ç›‘æ§</h1>
    <p class="page-subtitle">è¿½è¸ªåŒºå—é“¾å†å²ä¸Šçš„æ²»ç†å¤±è´¥ä¸ç¤¾åŒºåˆ†è£‚ â€” Gensler æ•™æˆçš„æ²»ç†éš¾é¢˜</p>
</div>

<div class="tool-layout">
    <!-- å·¦ä¾§ï¼šå†å²åˆ†å‰ -->
    <div class="panel">
        <h3 class="panel-title">ğŸ“œ å†å²ç¡¬åˆ†å‰äº‹ä»¶</h3>

        <div id="forkHistory">
            <!-- åŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <!-- å³ä¾§ï¼šé£é™©åˆ†æ -->
    <div class="panel">
        <h3 class="panel-title">âš ï¸ åˆ†å‰é£é™©åˆ†æ</h3>

        <div class="input-group">
            <label class="input-label">çŸ¿å·¥ä¿¡å·æ”¯æŒç‡ (%)</label>
            <input type="range" id="minerSupport" class="input-field" min="0" max="100" value="95"
                oninput="updateRiskLabel('minerSupport')">
            <span id="minerSupportLabel">95%</span>
        </div>

        <div class="input-group">
            <label class="input-label">ç¤¾åŒºåˆ†è£‚åº¦ (%)</label>
            <input type="range" id="communitySplit" class="input-field" min="0" max="100" value="10"
                oninput="updateRiskLabel('communitySplit')">
            <span id="communitySplitLabel">10%</span>
        </div>

        <div class="input-group">
            <label class="input-label">ä»£ç å˜æ›´è§„æ¨¡</label>
            <select id="codeChange" class="input-field">
                <option value="small">å°å‹ (Bugä¿®å¤)</option>
                <option value="medium" selected>ä¸­å‹ (åŠŸèƒ½å‡çº§)</option>
                <option value="large">å¤§å‹ (åè®®å˜æ›´)</option>
            </select>
        </div>

        <button class="btn btn-primary" onclick="analyzeRisk()" style="width: 100%;">
            ğŸ” åˆ†æé£é™©
        </button>

        <div id="riskResult" style="margin-top: 1.5rem;"></div>

        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-subtle); border-radius: 8px;">
            <h4 style="margin-bottom: 0.5rem;">ğŸ’¡ æŠ•èµ„å¯ç¤º</h4>
            <ul style="font-size: 0.85rem; color: var(--text-secondary); padding-left: 1rem;">
                <li>åˆ†å‰å‰æŒæœ‰å¯è·å¾—ä¸¤æ¡é“¾ä»£å¸</li>
                <li>æ²»ç†è‰¯å¥½çš„é¡¹ç›®åº”äº«ä¼°å€¼æº¢ä»·</li>
                <li>é¢‘ç¹äº‰è®®çš„é¡¹ç›®åº”å½“æŠ˜ä»·</li>
            </ul>
        </div>
    </div>
</div>

<script>
    function updateRiskLabel(id) {
        const value = document.getElementById(id).value;
        document.getElementById(id + 'Label').textContent = value + '%';
    }

    async function loadForkHistory() {
        const response = await fetch('/api/governance/forks');
        const forks = await response.json();

        const container = document.getElementById('forkHistory');
        container.innerHTML = '';

        forks.forEach(fork => {
            container.innerHTML += `
            <div style="padding: 1rem; border: 1px solid var(--border-subtle); border-radius: 8px; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <strong>${fork.name}</strong>
                    <span style="font-size: 0.8rem; color: var(--text-muted);">${fork.date}</span>
                </div>
                <div style="font-size: 0.85rem; color: var(--primary); margin-bottom: 0.5rem;">
                    ${fork.original} â†’ ${fork.fork}
                </div>
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                    <strong>èµ·å› ï¼š</strong>${fork.cause.substring(0, 80)}...
                </div>
                <div style="font-size: 0.85rem; padding: 0.5rem; background: var(--bg-subtle); border-radius: 4px;">
                    ğŸ’¡ ${fork.lesson.substring(0, 60)}...
                </div>
            </div>
        `;
        });
    }

    async function analyzeRisk() {
        const minerSupport = parseInt(document.getElementById('minerSupport').value);
        const communitySplit = parseInt(document.getElementById('communitySplit').value);
        const codeChange = document.getElementById('codeChange').value;

        const response = await fetch('/api/governance/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                miner_signaling: minerSupport,
                community_sentiment: communitySplit,
                code_change_size: codeChange
            })
        });

        const result = await response.json();

        const riskColors = { 'ğŸ”´ é«˜é£é™©': '#ef4444', 'ğŸŸ¡ ä¸­ç­‰é£é™©': '#f59e0b', 'ğŸŸ¢ ä½é£é™©': '#10b981' };
        const color = riskColors[result.risk_level] || '#6b7280';

        let factorsHtml = '';
        result.risk_factors.forEach(f => {
            factorsHtml += `<div style="font-size: 0.85rem; margin-bottom: 0.25rem;">${f}</div>`;
        });

        document.getElementById('riskResult').innerHTML = `
        <div class="result-box">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div style="font-size: 1.5rem;">${result.risk_level}</div>
                <div style="font-size: 2rem; font-weight: bold; color: ${color};">${result.risk_score}</div>
            </div>
            ${factorsHtml || '<div style="color: var(--success);">âœ… æœªå‘ç°æ˜æ˜¾é£é™©å› ç´ </div>'}
        </div>
        <div class="message info" style="margin-top: 1rem;">
            ${result.recommendation}
        </div>
    `;
    }

    loadForkHistory();
</script>
{% endblock %}
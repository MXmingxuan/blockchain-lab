{% extends "base.html" %}

{% block title %}éš¾åº¦è°ƒæ•´é¢„æµ‹ - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ“Š éš¾åº¦è°ƒæ•´é¢„æµ‹å™¨</h1>
    <p class="page-subtitle">é¢„æµ‹ä¸‹æ¬¡æ¯”ç‰¹å¸éš¾åº¦è°ƒæ•´ - æ¯2016ä¸ªåŒºå—è°ƒæ•´ä¸€æ¬¡</p>
</div>

<div class="panel" style="max-width: 900px; margin: 0 auto;">
    <div style="text-align: center; margin-bottom: 2rem;">
        <button class="btn btn-primary" onclick="loadPrediction()" style="font-size: 1.1rem; padding: 1rem 2rem;">
            ğŸ”„ è·å–æœ€æ–°é¢„æµ‹
        </button>
    </div>

    <div id="results" style="display: none;">
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="currentDiff">-</div>
                <div class="stat-label">å½“å‰éš¾åº¦</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="adjustment">-</div>
                <div class="stat-label">é¢„è®¡è°ƒæ•´</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="timeLeft">-</div>
                <div class="stat-label">è·ç¦»è°ƒæ•´</div>
            </div>
        </div>

        <div style="margin-top: 2rem;">
            <h3 class="panel-title">ğŸ“ˆ å‘¨æœŸè¿›åº¦</h3>
            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>å‘¨æœŸèµ·å§‹: åŒºå— <span id="epochStart">-</span></span>
                    <span>å·²å®Œæˆ: <span id="blocksCompleted">-</span> / 2016</span>
                </div>
                <div style="background: var(--bg-primary); border-radius: 4px; height: 24px; overflow: hidden;">
                    <div id="progressBar" style="background: var(--gradient-1); height: 100%; transition: width 0.5s;">
                    </div>
                </div>
                <div style="text-align: center; margin-top: 0.5rem; color: var(--text-secondary);">
                    <span id="progressPercent">0</span>%
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 2rem;">
            <div class="result-box">
                <div class="result-label">å‡ºå—æ—¶é—´åˆ†æ</div>
                <div style="margin-top: 0.5rem;">
                    <div>ç›®æ ‡æ—¶é—´: <span style="color: var(--accent-blue);">600 ç§’</span></div>
                    <div>å¹³å‡æ—¶é—´: <span id="avgBlockTime" style="color: var(--accent-green);">-</span></div>
                    <div>åå·®: <span id="timeDeviation">-</span></div>
                </div>
            </div>

            <div class="result-box">
                <div class="result-label">é¢„æµ‹è§£è¯»</div>
                <div id="interpretation" style="margin-top: 0.5rem; color: var(--text-secondary);"></div>
            </div>
        </div>

        <div class="message info" style="margin-top: 1.5rem;">
            ğŸ’¡ <strong>éš¾åº¦è°ƒæ•´æœºåˆ¶ï¼š</strong>æ¯”ç‰¹å¸æ¯2016ä¸ªåŒºå—ï¼ˆçº¦2å‘¨ï¼‰è°ƒæ•´ä¸€æ¬¡éš¾åº¦ï¼Œç¡®ä¿å¹³å‡å‡ºå—æ—¶é—´ç»´æŒåœ¨10åˆ†é’Ÿã€‚
            å¦‚æœç®—åŠ›å¢åŠ å¯¼è‡´å‡ºå—å˜å¿«ï¼Œéš¾åº¦å°±ä¼šä¸Šè°ƒï¼›åä¹‹ä¸‹è°ƒã€‚
        </div>
    </div>

    <div id="placeholder" class="message info">
        ğŸ‘† ç‚¹å‡»æŒ‰é’®è·å–æœ€æ–°çš„éš¾åº¦è°ƒæ•´é¢„æµ‹
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadPrediction() {
        const response = await fetch('/api/difficulty/predict');
        const data = await response.json();

        document.getElementById('results').style.display = 'block';
        document.getElementById('placeholder').style.display = 'none';

        document.getElementById('currentDiff').textContent = data.current.difficulty_human;

        const adj = data.prediction.adjustment_percent;
        const adjText = (adj >= 0 ? '+' : '') + adj.toFixed(2) + '%';
        document.getElementById('adjustment').textContent = adjText;
        document.getElementById('adjustment').style.color = adj >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';

        document.getElementById('timeLeft').textContent = data.prediction.time_until_adjustment;

        document.getElementById('epochStart').textContent = data.epoch.start_block.toLocaleString();
        document.getElementById('blocksCompleted').textContent = data.epoch.blocks_completed;
        document.getElementById('progressBar').style.width = data.epoch.progress_percent + '%';
        document.getElementById('progressPercent').textContent = data.epoch.progress_percent;

        document.getElementById('avgBlockTime').textContent = data.prediction.avg_block_time + ' ç§’';

        const deviation = ((data.prediction.avg_block_time - 600) / 600 * 100).toFixed(1);
        document.getElementById('timeDeviation').textContent = deviation + '%';
        document.getElementById('timeDeviation').style.color = Math.abs(deviation) < 5 ? 'var(--accent-green)' : 'var(--accent-orange)';

        document.getElementById('interpretation').textContent = data.interpretation;
    }
</script>
{% endblock %}
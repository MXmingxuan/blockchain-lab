{% extends "base.html" %}

{% block title %}çŠ¶æ€æ¨¡å‹å¯¹æ¯” - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">âš–ï¸ UTXO vs è´¦æˆ·æ¨¡å‹</h1>
    <p class="page-subtitle">å¯¹æ¯”æ¯”ç‰¹å¸ä¸ä»¥å¤ªåŠçš„çŠ¶æ€ç®¡ç†æ–¹å¼ï¼Œç†è§£ Gas æœºåˆ¶å­˜åœ¨çš„æ„ä¹‰</p>
</div>

<div class="tool-layout">
    <!-- å·¦ä¾§ï¼šæ¨¡å‹å¯¹æ¯” -->
    <div class="panel">
        <h3 class="panel-title">ğŸ“Š çŠ¶æ€æ¨¡å‹å¯¹æ¯”</h3>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
            <div style="padding: 1rem; background: #fff7ed; border-left: 4px solid #ea580c; border-radius: 4px;">
                <div style="font-weight: bold; color: #ea580c;">ğŸ”¶ Bitcoin (UTXO)</div>
                <ul style="font-size: 0.85rem; margin-top: 0.5rem; padding-left: 1rem;">
                    <li>æ²¡æœ‰"è´¦æˆ·"æ¦‚å¿µ</li>
                    <li>äº¤æ˜“æ¶ˆè´¹æ—§UTXO</li>
                    <li>ç”Ÿæˆæ–°UTXO</li>
                </ul>
            </div>
            <div style="padding: 1rem; background: #eff6ff; border-left: 4px solid #2563eb; border-radius: 4px;">
                <div style="font-weight: bold; color: #2563eb;">ğŸ”· Ethereum (Account)</div>
                <ul style="font-size: 0.85rem; margin-top: 0.5rem; padding-left: 1rem;">
                    <li>ç»´æŠ¤è´¦æˆ·ä½™é¢</li>
                    <li>ç›´æ¥ä¿®æ”¹ä½™é¢</li>
                    <li>æ”¯æŒæ™ºèƒ½åˆçº¦çŠ¶æ€</li>
                </ul>
            </div>
        </div>

        <div class="input-group">
            <label class="input-label">å‘é€è€…</label>
            <input type="text" id="sender" class="input-field" value="Alice">
        </div>

        <div class="input-group">
            <label class="input-label">æ¥æ”¶è€…</label>
            <input type="text" id="receiver" class="input-field" value="Bob">
        </div>

        <div class="input-group">
            <label class="input-label">é‡‘é¢</label>
            <input type="number" id="amount" class="input-field" value="3" step="0.1">
        </div>

        <button class="btn btn-primary" onclick="executeTransfer()" style="width: 100%;">
            ğŸ”„ æ‰§è¡Œè½¬è´¦
        </button>

        <div id="transferResult" style="margin-top: 1.5rem;">
            <!-- è½¬è´¦ç»“æœ -->
        </div>
    </div>

    <!-- å³ä¾§ï¼šGas æ¨¡æ‹Ÿ -->
    <div class="panel">
        <h3 class="panel-title">â›½ Gas æœºåˆ¶æ¼”ç¤º</h3>

        <div class="result-box" style="margin-bottom: 1rem;">
            <div class="result-label">ä¸ºä»€ä¹ˆéœ€è¦ Gasï¼Ÿ</div>
            <div style="font-size: 0.95rem;">
                ä»¥å¤ªåŠæ˜¯<strong>å›¾çµå®Œå¤‡</strong>çš„ï¼Œå¯ä»¥è¿è¡Œä»»æ„ä»£ç ï¼ˆåŒ…æ‹¬æ­»å¾ªç¯ï¼‰ã€‚<br>
                Gas ç¡®ä¿æ¯ä¸ªæ“ä½œéƒ½æœ‰æˆæœ¬ï¼Œé˜²æ­¢æ— é™å¾ªç¯å¯¼è‡´ç½‘ç»œç˜«ç—ªã€‚
            </div>
        </div>

        <div class="input-group">
            <label class="input-label">Gas é™åˆ¶</label>
            <input type="number" id="gasLimit" class="input-field" value="50" min="1" max="1000">
        </div>

        <div class="input-group">
            <label class="input-label">å¾ªç¯æ¬¡æ•°ï¼ˆå°è¯•æ‰§è¡Œï¼‰</label>
            <input type="number" id="loopCount" class="input-field" value="100" min="1">
        </div>

        <button class="btn btn-secondary" onclick="simulateGas()" style="width: 100%;">
            âš¡ æ¨¡æ‹Ÿæ‰§è¡Œ
        </button>

        <div id="gasResult" style="margin-top: 1.5rem;">
            <!-- Gas æ¨¡æ‹Ÿç»“æœ -->
        </div>

        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-subtle); border-radius: 8px;">
            <h4 style="margin-bottom: 0.5rem;">ğŸ’¡ æ“ä½œ Gas æ¶ˆè€—å‚è€ƒ</h4>
            <table style="width: 100%; font-size: 0.85rem;">
                <tr>
                    <td>ADD (åŠ æ³•)</td>
                    <td style="text-align: right;">3 Gas</td>
                </tr>
                <tr>
                    <td>SSTORE (å­˜å‚¨å†™å…¥)</td>
                    <td style="text-align: right;">20,000 Gas</td>
                </tr>
                <tr>
                    <td>CALL (å¤–éƒ¨è°ƒç”¨)</td>
                    <td style="text-align: right;">2,300 Gas</td>
                </tr>
            </table>
        </div>
    </div>
</div>

<script>
    async function executeTransfer() {
        const sender = document.getElementById('sender').value;
        const receiver = document.getElementById('receiver').value;
        const amount = parseFloat(document.getElementById('amount').value);

        const response = await fetch('/api/state/transfer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sender, receiver, amount })
        });

        const result = await response.json();

        const resultDiv = document.getElementById('transferResult');

        let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">';

        // UTXO æ¨¡å‹ç»“æœ
        html += `
        <div class="result-box">
            <div class="result-label">ğŸ”¶ UTXO æ¨¡å‹</div>
            ${result.utxo.history.map(h => `
                <div style="font-size: 0.85rem; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--bg-surface); border-radius: 4px;">
                    <strong>${h.action}</strong><br>
                    ${h.state_change}
                </div>
            `).join('')}
        </div>
    `;

        // è´¦æˆ·æ¨¡å‹ç»“æœ
        html += `
        <div class="result-box">
            <div class="result-label">ğŸ”· è´¦æˆ·æ¨¡å‹</div>
            ${result.account.history.map(h => `
                <div style="font-size: 0.85rem; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--bg-surface); border-radius: 4px;">
                    <strong>${h.action}</strong><br>
                    ${h.state_change}
                </div>
            `).join('')}
        </div>
    `;

        html += '</div>';
        resultDiv.innerHTML = html;
    }

    async function simulateGas() {
        const gasLimit = parseInt(document.getElementById('gasLimit').value);
        const loopCount = parseInt(document.getElementById('loopCount').value);

        const response = await fetch('/api/state/gas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ gas_limit: gasLimit, iterations: loopCount })
        });

        const result = await response.json();

        const resultDiv = document.getElementById('gasResult');

        const stoppedByGas = result.stopped_reason === 'OUT_OF_GAS';

        resultDiv.innerHTML = `
        <div class="result-box">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center; margin-bottom: 1rem;">
                <div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">è¯·æ±‚è¿­ä»£</div>
                    <div style="font-size: 1.5rem; font-weight: bold;">${result.requested_iterations}</div>
                </div>
                <div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">å®é™…æ‰§è¡Œ</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: ${stoppedByGas ? 'var(--danger)' : 'var(--success)'};">${result.actual_iterations}</div>
                </div>
                <div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">Gas æ¶ˆè€—</div>
                    <div style="font-size: 1.5rem; font-weight: bold;">${result.gas_used}/${result.gas_limit}</div>
                </div>
            </div>
            <div class="message ${stoppedByGas ? 'warning' : 'success'}">
                ${stoppedByGas
                ? 'â›½ å›  Gas è€—å°½è€Œåœæ­¢ â€” è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ­»å¾ªç¯ä¸ä¼šè®©ä»¥å¤ªåŠå´©æºƒï¼'
                : 'âœ… æˆåŠŸå®Œæˆæ‰€æœ‰è¿­ä»£'}
            </div>
        </div>
    `;
    }
</script>
{% endblock %}
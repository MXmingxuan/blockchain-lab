{% extends "base.html" %}

{% block title %}é›¶çŸ¥è¯†è¯æ˜æ¼”ç¤º - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ” é›¶çŸ¥è¯†è¯æ˜æ¼”ç¤º</h1>
    <p class="page-subtitle">è¯æ˜"æˆ‘çŸ¥é“ç§˜å¯†"è€Œä¸æ³„éœ²ç§˜å¯† â€” é…’å§å¹´é¾„éªŒè¯åœºæ™¯</p>
</div>

<div class="tool-layout">
    <!-- å·¦ä¾§ï¼šäº¤äº’å¼è¯æ˜ -->
    <div class="panel">
        <h3 class="panel-title">ğŸº é…’å§å¹´é¾„éªŒè¯</h3>

        <div class="result-box" style="margin-bottom: 1rem;">
            <div style="font-size: 0.9rem; font-style: italic;">
                "æˆ‘æƒ³è¿›é…’å§å–é…’ï¼Œä½†æˆ‘ä¸æƒ³å‡ºç¤ºèº«ä»½è¯ç»™é™Œç”Ÿäººçœ‹æˆ‘çš„ç”Ÿæ—¥ã€ä½å€ç­‰éšç§ä¿¡æ¯ã€‚
                æˆ‘åªéœ€è¦è¯æ˜<strong>æˆ‘å·²æ»¡21å²</strong>è¿™ä¸€ä¸ªäº‹å®ã€‚"
            </div>
        </div>

        <div class="input-group">
            <label class="input-label">ä½ çš„å‡ºç”Ÿå¹´ä»½ï¼ˆç§˜å¯†ï¼‰</label>
            <input type="number" id="birthYear" class="input-field" value="1995" min="1950" max="2010">
            <div style="font-size: 0.8rem; color: var(--text-muted);">è¿™æ˜¯ä½ è¦ä¿æŠ¤çš„éšç§ä¿¡æ¯</div>
        </div>

        <div class="input-group">
            <label class="input-label">å¹´é¾„é—¨æ§›</label>
            <input type="number" id="threshold" class="input-field" value="21" min="18" max="65">
        </div>

        <button class="btn btn-primary" onclick="generateProof()" style="width: 100%;">
            ğŸ”® ç”Ÿæˆé›¶çŸ¥è¯†è¯æ˜
        </button>

        <div id="proofResult" style="margin-top: 1.5rem;"></div>
    </div>

    <!-- å³ä¾§ï¼šéªŒè¯æ­¥éª¤ -->
    <div class="panel">
        <h3 class="panel-title">ğŸ“‹ éªŒè¯æµç¨‹</h3>

        <div id="verificationSteps">
            <div class="message info">ç‚¹å‡»"ç”Ÿæˆé›¶çŸ¥è¯†è¯æ˜"æŸ¥çœ‹å®Œæ•´éªŒè¯æµç¨‹</div>
        </div>

        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-subtle); border-radius: 8px;">
            <h4 style="margin-bottom: 0.5rem;">ğŸ’¡ ZKP æ ¸å¿ƒå±æ€§</h4>
            <ul style="font-size: 0.9rem; color: var(--text-secondary); padding-left: 1.2rem;">
                <li><strong>å®Œå¤‡æ€§</strong>ï¼šè¯šå®çš„è¯æ˜è€…èƒ½è¯´æœéªŒè¯è€…</li>
                <li><strong>å¯é æ€§</strong>ï¼šéª—å­æ— æ³•æ¬ºéª—éªŒè¯è€…</li>
                <li><strong>é›¶çŸ¥è¯†</strong>ï¼šéªŒè¯è€…åªçŸ¥é“"ç»“è®º"ï¼Œä¸çŸ¥é“"ç§˜å¯†"</li>
            </ul>
        </div>

        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-subtle); border-radius: 8px;">
            <h4 style="margin-bottom: 0.5rem;">ğŸŒ ç°å®åº”ç”¨</h4>
            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                <div>â€¢ <strong>Zcash</strong>: éšç§äº¤æ˜“</div>
                <div>â€¢ <strong>èº«ä»½éªŒè¯</strong>: è¯æ˜èµ„è´¨ä¸æ³„éœ²ä¿¡æ¯</div>
                <div>â€¢ <strong>æŠ•ç¥¨</strong>: åŒ¿åä½†å¯éªŒè¯</div>
            </div>
        </div>
    </div>
</div>

<script>
    async function generateProof() {
        const birthYear = parseInt(document.getElementById('birthYear').value);
        const threshold = parseInt(document.getElementById('threshold').value);

        const response = await fetch('/api/zkp/prove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ birth_year: birthYear, threshold: threshold })
        });

        const result = await response.json();

        // æ˜¾ç¤ºè¯æ˜ç»“æœ
        const proofDiv = document.getElementById('proofResult');
        const passed = result.result.claim_verified;

        proofDiv.innerHTML = `
        <div class="result-box">
            <div class="result-label">æ‰¿è¯º (Commitment)</div>
            <div style="font-family: monospace; font-size: 0.8rem; word-break: break-all;">
                ${result.commitment}
            </div>
        </div>
        
        <div class="message ${passed ? 'success' : 'warning'}" style="margin-top: 1rem;">
            ${result.result.message}
        </div>
    `;

        // æ˜¾ç¤ºéªŒè¯æ­¥éª¤
        const stepsDiv = document.getElementById('verificationSteps');
        let stepsHtml = '';

        result.verification_steps.forEach(step => {
            stepsHtml += `
            <div class="result-box" style="margin-bottom: 0.75rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="background: var(--primary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">
                        ${step.step}
                    </span>
                    <strong>${step.action}</strong>
                </div>
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-left: 32px;">
                    ${step.detail}
                </div>
                <div style="font-size: 0.8rem; margin-left: 32px; margin-top: 0.25rem;">
                    <span style="color: var(--success);">Prover: ${step.prover_reveals}</span><br>
                    <span style="color: var(--primary);">Verifier: ${step.verifier_learns}</span>
                </div>
            </div>
        `;
        });

        stepsDiv.innerHTML = stepsHtml;
    }
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}é¢„è¨€æœºæ¼”ç¤º - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ”® é¢„è¨€æœºæ¼”ç¤º</h1>
    <p class="page-subtitle">ä½“éªŒå¤–éƒ¨æ•°æ®å¦‚ä½•è§¦å‘æ™ºèƒ½åˆçº¦è‡ªåŠ¨æ‰§è¡Œ â€” èˆªç­å»¶è¯¯ä¿é™©æ¡ˆä¾‹</p>
</div>

<div class="tool-layout">
    <!-- å·¦ä¾§ï¼šèˆªç­æŸ¥è¯¢ä¸ä¿é™© -->
    <div class="panel">
        <h3 class="panel-title">âœˆï¸ èˆªç­å»¶è¯¯ä¿é™©</h3>

        <div class="input-group">
            <label class="input-label">é€‰æ‹©èˆªç­</label>
            <select id="flightSelect" class="input-field" onchange="checkFlight()">
                <option value="">-- é€‰æ‹©èˆªç­ --</option>
            </select>
        </div>

        <div id="flightInfo"
            style="padding: 1rem; background: var(--bg-subtle); border-radius: 8px; margin-bottom: 1.5rem; display: none;">
            <!-- èˆªç­ä¿¡æ¯ -->
        </div>

        <div class="input-group">
            <label class="input-label">ä¿å• ID</label>
            <input type="text" id="policyId" class="input-field" value="POL001" placeholder="è¾“å…¥ä¿å•ID">
        </div>

        <div class="btn-group" style="margin-bottom: 1.5rem;">
            <button class="btn btn-primary" onclick="purchaseInsurance()">ğŸ“ è´­ä¹°ä¿é™©</button>
            <button class="btn btn-secondary" onclick="claimInsurance()">ğŸ’° ç”³è¯·ç†èµ”</button>
        </div>

        <div id="claimResult" style="display: none;">
            <!-- ç†èµ”ç»“æœ -->
        </div>
    </div>

    <!-- å³ä¾§ï¼šé¢„è¨€æœºæ¦‚å¿µ -->
    <div class="panel">
        <h3 class="panel-title">ğŸ§  ä»€ä¹ˆæ˜¯é¢„è¨€æœºï¼Ÿ</h3>

        <div class="result-box" style="margin-bottom: 1rem;">
            <div class="result-label">æ ¸å¿ƒé—®é¢˜</div>
            <div style="font-size: 0.95rem;">
                åŒºå—é“¾æ˜¯<strong>å°é—­ç³»ç»Ÿ</strong>ï¼Œæ— æ³•ç›´æ¥è·å–å¤–éƒ¨æ•°æ®ã€‚<br>
                å¦‚ä½•çŸ¥é“"èˆªç­å»¶è¯¯äº†60åˆ†é’Ÿ"è¿™ä¸ªç°å®ä¸–ç•Œçš„äº‹å®ï¼Ÿ
            </div>
        </div>

        <div class="result-box" style="margin-bottom: 1rem;">
            <div class="result-label">è§£å†³æ–¹æ¡ˆ</div>
            <div style="font-size: 0.95rem;">
                <strong>é¢„è¨€æœº (Oracle)</strong>: è¿æ¥åŒºå—é“¾ä¸ç°å®ä¸–ç•Œçš„æ¡¥æ¢
            </div>
        </div>

        <div id="executionSteps" style="margin-top: 1.5rem;">
            <h4 style="margin-bottom: 1rem;">ğŸ“‹ æ‰§è¡Œæµç¨‹</h4>
            <div id="stepsContainer">
                <div class="message info">é€‰æ‹©èˆªç­å¹¶è´­ä¹°ä¿é™©ï¼Œä½“éªŒé¢„è¨€æœºå·¥ä½œæµç¨‹</div>
            </div>
        </div>

        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-subtle); border-radius: 8px;">
            <h4 style="margin-bottom: 0.5rem;">ğŸ’¡ æŠ•èµ„ä»·å€¼</h4>
            <p style="font-size: 0.9rem; color: var(--text-secondary);">
                ç†è§£é¢„è¨€æœºçš„ä»·å€¼åï¼Œå¯ä»¥è¯„ä¼° <strong>Chainlink</strong> ç­‰è§£å†³æ•°æ®ä¸Šé“¾é—®é¢˜çš„é¡¹ç›®ã€‚
                æ²¡æœ‰å¯ä¿¡æ•°æ®ï¼Œæ™ºèƒ½åˆçº¦æ— æ³•æ‰§è¡Œç°å®ä¸–ç•Œçš„é€»è¾‘ã€‚
            </p>
        </div>
    </div>
</div>

<script>
    async function loadFlights() {
        const response = await fetch('/api/oracle/flights');
        const flights = await response.json();

        const select = document.getElementById('flightSelect');
        flights.forEach(f => {
            if (f.found) {
                select.innerHTML += `<option value="${f.flight_number}">${f.status_emoji} ${f.flight_number}: ${f.route} (å»¶è¯¯ ${f.delay_minutes} åˆ†é’Ÿ)</option>`;
            }
        });
    }

    async function checkFlight() {
        const flightNumber = document.getElementById('flightSelect').value;
        if (!flightNumber) return;

        const response = await fetch(`/api/oracle/check?flight=${flightNumber}`);
        const data = await response.json();

        const infoDiv = document.getElementById('flightInfo');
        infoDiv.style.display = 'block';
        infoDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span style="font-weight: bold;">${data.status_emoji} ${data.flight_number}</span>
            <span style="color: var(--text-muted);">${data.route}</span>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
            <div>è®¡åˆ’: ${data.scheduled}</div>
            <div>å®é™…: ${data.actual}</div>
            <div>çŠ¶æ€: ${data.status}</div>
            <div style="color: ${data.delay_minutes >= 60 ? 'var(--danger)' : 'var(--success)'};">
                å»¶è¯¯: ${data.delay_minutes} åˆ†é’Ÿ
            </div>
        </div>
    `;
    }

    async function purchaseInsurance() {
        const flightNumber = document.getElementById('flightSelect').value;
        const policyId = document.getElementById('policyId').value;

        if (!flightNumber || !policyId) {
            alert('è¯·é€‰æ‹©èˆªç­å¹¶è¾“å…¥ä¿å•ID');
            return;
        }

        const response = await fetch('/api/oracle/purchase', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ flight: flightNumber, policy_id: policyId })
        });

        const result = await response.json();

        const stepsDiv = document.getElementById('stepsContainer');
        if (result.success) {
            stepsDiv.innerHTML = `<div class="message success">âœ… ${result.message}</div>`;
        } else {
            stepsDiv.innerHTML = `<div class="message error">âŒ ${result.error}: ${result.message}</div>`;
        }
    }

    async function claimInsurance() {
        const policyId = document.getElementById('policyId').value;

        const response = await fetch('/api/oracle/claim', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ policy_id: policyId })
        });

        const result = await response.json();

        const stepsDiv = document.getElementById('stepsContainer');

        if (result.steps) {
            let stepsHtml = '';
            result.steps.forEach(step => {
                stepsHtml += `
                <div class="result-box" style="margin-bottom: 0.5rem;">
                    <strong>æ­¥éª¤ ${step.step}:</strong> ${step.action}<br>
                    <span style="color: var(--text-secondary);">${step.detail}</span>
                </div>
            `;
            });

            stepsHtml += `
            <div class="message ${result.claimed ? 'success' : 'info'}" style="margin-top: 1rem;">
                ${result.message}
            </div>
        `;

            stepsDiv.innerHTML = stepsHtml;
        } else {
            stepsDiv.innerHTML = `<div class="message error">âŒ ${result.error}: ${result.message}</div>`;
        }
    }

    loadFlights();
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}æ•°å­—ç­¾åæ¨¡æ‹Ÿå™¨ - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">âœï¸ æ•°å­—ç­¾åæ¨¡æ‹Ÿå™¨</h1>
    <p class="page-subtitle">ECDSA éå¯¹ç§°åŠ å¯† - åœ¨ä¸æ³„éœ²ç§é’¥çš„æƒ…å†µä¸‹è¯æ˜èº«ä»½</p>
</div>

<div class="tool-layout">
    <div class="panel">
        <h2 class="panel-title">ğŸ”‘ å¯†é’¥ç®¡ç†</h2>

        <button class="btn btn-primary" onclick="generateKeys()" style="width: 100%;">
            ğŸ² ç”Ÿæˆæ–°å¯†é’¥å¯¹
        </button>

        <div class="result-box" style="margin-top: 1rem;">
            <div class="result-label">ç§é’¥ (Private Key) - ä¿å¯†ï¼</div>
            <div class="result-value" id="privateKey" style="color: var(--accent-red);">å°šæœªç”Ÿæˆ</div>
        </div>

        <div class="result-box">
            <div class="result-label">å…¬é’¥ (Public Key) - å¯å…¬å¼€</div>
            <div class="result-value" id="publicKey">å°šæœªç”Ÿæˆ</div>
        </div>

        <hr style="border-color: var(--border-color); margin: 1.5rem 0;">

        <h3 class="panel-title" style="margin-top: 0;">ğŸ“ ç­¾åæ¶ˆæ¯</h3>

        <div class="input-group">
            <label class="input-label">è¦ç­¾åçš„æ¶ˆæ¯</label>
            <input type="text" id="message" class="input-field" value="Alice pays Bob 1 BTC" placeholder="è¾“å…¥æ¶ˆæ¯">
        </div>

        <button class="btn btn-success" onclick="signMessage()">
            âœï¸ ç­¾å
        </button>

        <div class="result-box" style="margin-top: 1rem;">
            <div class="result-label">ç­¾å (Signature)</div>
            <div class="result-value" id="signature">å°šæœªç­¾å</div>
        </div>
    </div>

    <div class="panel">
        <h2 class="panel-title">âœ… éªŒè¯ç­¾å</h2>

        <div class="input-group">
            <label class="input-label">éªŒè¯æ¶ˆæ¯</label>
            <input type="text" id="verifyMessage" class="input-field" placeholder="è¾“å…¥è¦éªŒè¯çš„æ¶ˆæ¯">
        </div>

        <div class="input-group">
            <label class="input-label">éªŒè¯ç”¨å…¬é’¥</label>
            <input type="text" id="verifyPublicKey" class="input-field" placeholder="è¾“å…¥å…¬é’¥">
        </div>

        <div class="btn-group">
            <button class="btn btn-primary" onclick="verifyCorrect()">
                âœ… æ­£ç¡®å…¬é’¥éªŒè¯
            </button>
            <button class="btn btn-danger" onclick="verifyWrong()">
                âŒ é”™è¯¯å…¬é’¥éªŒè¯
            </button>
        </div>

        <div id="verifyResult" style="margin-top: 1.5rem;"></div>

        <hr style="border-color: var(--border-color); margin: 1.5rem 0;">

        <h3 class="panel-title" style="margin-top: 0;">ğŸ§ª æ”»å‡»æµ‹è¯•</h3>

        <div class="input-group">
            <label class="input-label">ç¯¡æ”¹æ¶ˆæ¯</label>
            <input type="text" id="tamperedMessage" class="input-field" value="Alice pays Bob 100 BTC"
                placeholder="å°è¯•ç¯¡æ”¹æ¶ˆæ¯">
        </div>

        <button class="btn btn-danger" onclick="verifyTampered()">
            ğŸ’€ éªŒè¯ç¯¡æ”¹æ¶ˆæ¯
        </button>

        <div id="tamperedResult" style="margin-top: 1rem;"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentKeys = { private_key: '', public_key: '' };
    let currentSignature = '';

    async function generateKeys() {
        const response = await fetch('/api/signature/generate');
        const data = await response.json();

        if (data.error) {
            alert(data.error);
            return;
        }

        currentKeys = data;
        document.getElementById('privateKey').textContent = data.private_key.substring(0, 32) + '...';
        document.getElementById('publicKey').textContent = data.public_key.substring(0, 32) + '...';
        document.getElementById('verifyPublicKey').value = data.public_key;
    }

    async function signMessage() {
        if (!currentKeys.private_key) {
            alert('è¯·å…ˆç”Ÿæˆå¯†é’¥å¯¹');
            return;
        }

        const message = document.getElementById('message').value;

        const response = await fetch('/api/signature/sign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                private_key: currentKeys.private_key
            })
        });

        const data = await response.json();

        if (data.error) {
            alert(data.error);
            return;
        }

        currentSignature = data.signature;
        document.getElementById('signature').textContent = data.signature.substring(0, 32) + '...';
        document.getElementById('verifyMessage').value = message;
    }

    async function verifySignature(message, publicKey, resultDivId) {
        if (!currentSignature) {
            alert('è¯·å…ˆç­¾åæ¶ˆæ¯');
            return;
        }

        const response = await fetch('/api/signature/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                signature: currentSignature,
                public_key: publicKey
            })
        });

        const data = await response.json();
        const resultDiv = document.getElementById(resultDivId);

        if (data.valid) {
            resultDiv.innerHTML = `
            <div class="validation-status valid">
                âœ… éªŒè¯é€šè¿‡ï¼ç­¾åæœ‰æ•ˆ
            </div>`;
        } else {
            resultDiv.innerHTML = `
            <div class="validation-status invalid">
                âŒ éªŒè¯å¤±è´¥ï¼${data.reason || 'ç­¾åæ— æ•ˆ'}
            </div>`;
        }
    }

    function verifyCorrect() {
        const message = document.getElementById('verifyMessage').value;
        verifySignature(message, currentKeys.public_key, 'verifyResult');
    }

    async function verifyWrong() {
        // ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯†é’¥å¯¹ä½œä¸º"é”™è¯¯çš„"å…¬é’¥
        const response = await fetch('/api/signature/generate');
        const wrongKeys = await response.json();

        const message = document.getElementById('verifyMessage').value;
        verifySignature(message, wrongKeys.public_key, 'verifyResult');
    }

    function verifyTampered() {
        const message = document.getElementById('tamperedMessage').value;
        verifySignature(message, currentKeys.public_key, 'tamperedResult');
    }
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Coinbase è§£ç å™¨ - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ“ Coinbase ç§˜å¯†ä¿¡æ¯è§£ç å™¨</h1>
    <p class="page-subtitle">è§£ç çŸ¿å·¥åœ¨åŒºå—ä¸­ç•™ä¸‹çš„æ¶ˆæ¯ - é“¾ä¸Šçš„"æ¶‚é¸¦å¢™"</p>
</div>

<div class="tool-layout">
    <div class="panel">
        <h2 class="panel-title">ğŸ›ï¸ åˆ›ä¸–åŒºå—</h2>

        <div id="genesisBlock">
            <div class="message">åŠ è½½ä¸­...</div>
        </div>

        <hr style="border-color: var(--border-color); margin: 1.5rem 0;">

        <h3 class="panel-title" style="margin-top: 0;">ğŸ” æŸ¥è¯¢åŒºå—</h3>

        <div class="input-group">
            <label class="input-label">åŒºå—é«˜åº¦</label>
            <input type="number" id="blockHeight" class="input-field" value="630000" min="0">
        </div>

        <button class="btn btn-primary" onclick="decodeBlock()" style="width: 100%;">
            ğŸ” è§£ç  Coinbase
        </button>

        <div id="decodeResult" style="margin-top: 1rem;"></div>
    </div>

    <div class="panel">
        <h2 class="panel-title">ğŸ“œ å†å²è‘—åæ¶ˆæ¯</h2>

        <div id="famousMessages">
            <div class="message">åŠ è½½ä¸­...</div>
        </div>

        <hr style="border-color: var(--border-color); margin: 1.5rem 0;">

        <div class="message info">
            <strong>ğŸ’¡ Coinbase äº¤æ˜“çš„ç‰¹æ®Šæ€§</strong>
            <ul style="margin-top: 0.5rem; color: var(--text-secondary); padding-left: 1.5rem;">
                <li>æ¯ä¸ªåŒºå—çš„ç¬¬ä¸€ç¬”äº¤æ˜“æ˜¯ Coinbase äº¤æ˜“</li>
                <li>å®ƒæ²¡æœ‰è¾“å…¥ï¼ˆå‡­ç©ºåˆ›é€ æ–°å¸ï¼‰</li>
                <li>çŸ¿å·¥å¯ä»¥åœ¨ ScriptSig ä¸­å†™å…¥æœ€å¤š 100 å­—èŠ‚æ•°æ®</li>
                <li>è¿™äº›æ•°æ®æ°¸ä¹…è®°å½•åœ¨åŒºå—é“¾ä¸Š</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadGenesisBlock() {
        try {
            const response = await fetch('/api/coinbase/genesis');
            const data = await response.json();

            document.getElementById('genesisBlock').innerHTML = `
            <div class="result-box" style="border-left: 4px solid var(--accent-purple);">
                <div class="result-label">åŒºå— #0 - åˆ›ä¸–åŒºå—</div>
                <div style="font-size: 1.1rem; margin: 0.5rem 0; font-style: italic; color: var(--accent-blue);">
                    "${data.decoded_message}"
                </div>
                <div style="color: var(--text-secondary); font-size: 0.9rem;">
                    ${data.significance}
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">
                    ${data.historical_context}
                </div>
            </div>`;
        } catch (error) {
            document.getElementById('genesisBlock').innerHTML =
                `<div class="message error">åŠ è½½å¤±è´¥</div>`;
        }
    }

    async function loadFamousMessages() {
        try {
            const response = await fetch('/api/coinbase/famous');
            const data = await response.json();

            let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';

            data.forEach(msg => {
                html += `
                <div class="result-box" style="padding: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="font-weight: bold;">${msg.name}</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">åŒºå— #${msg.block_height.toLocaleString()}</div>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${msg.date}</div>
                    </div>
                    <div style="margin-top: 0.5rem; font-style: italic; color: var(--accent-blue); font-size: 0.9rem;">
                        "${msg.message.substring(0, 60)}${msg.message.length > 60 ? '...' : ''}"
                    </div>
                    <div style="margin-top: 0.25rem; font-size: 0.85rem; color: var(--text-secondary);">
                        ${msg.significance}
                    </div>
                </div>`;
            });

            html += '</div>';
            document.getElementById('famousMessages').innerHTML = html;
        } catch (error) {
            document.getElementById('famousMessages').innerHTML =
                `<div class="message error">åŠ è½½å¤±è´¥</div>`;
        }
    }

    async function decodeBlock() {
        const height = parseInt(document.getElementById('blockHeight').value);

        document.getElementById('decodeResult').innerHTML =
            '<div class="message">æ­£åœ¨è§£ç ...</div>';

        try {
            const response = await fetch('/api/coinbase/decode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ height })
            });
            const data = await response.json();

            if (data.success) {
                document.getElementById('decodeResult').innerHTML = `
                <div class="result-box">
                    <div class="result-label">åŒºå— #${data.block_height.toLocaleString()}</div>
                    <div style="margin-top: 0.5rem;">
                        <div style="color: var(--text-muted); font-size: 0.85rem;">çŸ¿æ± : ${data.miner}</div>
                        <div style="margin-top: 0.5rem; font-style: italic; color: var(--accent-blue);">
                            "${data.decoded_message || '(æ— å¯è¯»æ¶ˆæ¯)'}"
                        </div>
                    </div>
                </div>`;
            } else {
                document.getElementById('decodeResult').innerHTML =
                    `<div class="message error">${data.error}</div>`;
            }
        } catch (error) {
            document.getElementById('decodeResult').innerHTML =
                `<div class="message error">è§£ç å¤±è´¥: ${error.message}</div>`;
        }
    }

    // é¡µé¢åŠ è½½æ—¶
    loadGenesisBlock();
    loadFamousMessages();
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}ç§‘æ–¯å®šç†åˆ†æå™¨ - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">âš–ï¸ ç§‘æ–¯å®šç†æŠ•èµ„åˆ†æ</h1>
    <p class="page-subtitle">ä¸­å¿ƒåŒ–æ•ˆç‡ vs å»ä¸­å¿ƒåŒ–æˆæœ¬ â€” é¡¹ç›®çœŸçš„éœ€è¦åŒºå—é“¾å—ï¼Ÿ</p>
</div>

<div class="tool-layout">
    <!-- å·¦ä¾§ï¼šé¡¹ç›®åˆ—è¡¨ -->
    <div class="panel">
        <h3 class="panel-title">ğŸ“Š é¡¹ç›®å¯¹æ¯”</h3>

        <div class="result-box" style="margin-bottom: 1rem;">
            <div class="result-label">ç§‘æ–¯å®šç†</div>
            <div style="font-size: 0.9rem;">
                ä¼ä¸šï¼ˆä¸­å¿ƒåŒ–ï¼‰å­˜åœ¨æ˜¯ä¸ºäº†é™ä½äº¤æ˜“æˆæœ¬ã€‚<br>
                å»ä¸­å¿ƒåŒ–çš„ä»£ä»·æ˜¯<strong>åè°ƒæˆæœ¬</strong>ã€‚<br>
                <strong>é—®é¢˜</strong>ï¼šä¸€ä¸ªé¡¹ç›®ä½•æ—¶åº”è¯¥å»ä¸­å¿ƒåŒ–ï¼Ÿ
            </div>
        </div>

        <div id="projectList">
            <!-- åŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <!-- å³ä¾§ï¼šè¯¦ç»†åˆ†æ -->
    <div class="panel">
        <h3 class="panel-title">ğŸ” è¯¦ç»†åˆ†æ</h3>

        <div id="projectDetail">
            <div class="message info">ç‚¹å‡»å·¦ä¾§é¡¹ç›®æŸ¥çœ‹ç§‘æ–¯å®šç†åˆ†æ</div>
        </div>

        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-subtle); border-radius: 8px;">
            <h4 style="margin-bottom: 0.5rem;">ğŸš© æŠ•èµ„çº¢æ——</h4>
            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                <div style="margin-bottom: 0.25rem;">â€¢ å£°ç§°å»ä¸­å¿ƒåŒ–ï¼Œå®é™…å°‘æ•°äººæ§åˆ¶</div>
                <div style="margin-bottom: 0.25rem;">â€¢ ç”¨ä¾‹é€‚åˆä¸­å¿ƒåŒ–ï¼Œä½†å¼ºè¡Œä¸Šé“¾</div>
                <div>â€¢ æ²»ç†æ··ä¹±ï¼Œæ— æ³•æœ‰æ•ˆå‡çº§</div>
            </div>
        </div>

        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-subtle); border-radius: 8px;">
            <h4 style="margin-bottom: 0.5rem;">âœ… æŠ•èµ„ç»¿æ——</h4>
            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                <div style="margin-bottom: 0.25rem;">â€¢ å»ä¸­å¿ƒåŒ–ç¨‹åº¦ä¸ç”¨ä¾‹éœ€æ±‚åŒ¹é…</div>
                <div style="margin-bottom: 0.25rem;">â€¢ æœ‰æ•ˆçš„æ²»ç†æœºåˆ¶</div>
                <div>â€¢ æ¸…æ™°çš„"ä¸ºä»€ä¹ˆéœ€è¦åŒºå—é“¾"ç­”æ¡ˆ</div>
            </div>
        </div>
    </div>
</div>

<script>
    async function loadProjects() {
        const response = await fetch('/api/coase/list');
        const projects = await response.json();

        const container = document.getElementById('projectList');
        container.innerHTML = '';

        projects.forEach(p => {
            const scoreColor = p.coase_score > 2 ? '#f59e0b' : p.coase_score < -2 ? '#10b981' : '#6b7280';

            const item = document.createElement('div');
            item.style.cssText = 'padding: 1rem; border: 1px solid var(--border-subtle); border-radius: 8px; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s;';
            item.onmouseover = () => item.style.borderColor = 'var(--primary)';
            item.onmouseout = () => item.style.borderColor = 'var(--border-subtle)';
            item.onclick = () => analyzeProject(p.name);

            item.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: bold;">${p.name}</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">${p.category}</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.8rem; color: var(--text-muted);">å»ä¸­å¿ƒåŒ–</div>
                    <div style="font-weight: bold;">${p.actual_decentralization}/10</div>
                </div>
            </div>
            <div style="font-size: 0.85rem; margin-top: 0.5rem; color: ${scoreColor};">
                ç§‘æ–¯åˆ†æ•°: ${p.coase_score} â€” ${p.verdict}
            </div>
        `;

            container.appendChild(item);
        });
    }

    async function analyzeProject(name) {
        const response = await fetch(`/api/coase/analyze?name=${encodeURIComponent(name)}`);
        const result = await response.json();

        if (!result.found) {
            document.getElementById('projectDetail').innerHTML = `<div class="message error">${result.error}</div>`;
            return;
        }

        const analysis = result.analysis;
        const metrics = result.metrics;
        const raw = result.raw_scores;

        const verdictColors = { success: '#10b981', warning: '#f59e0b', info: '#6b7280' };
        const color = verdictColors[analysis.verdict_color];

        document.getElementById('projectDetail').innerHTML = `
        <div class="result-box" style="margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div>
                    <div style="font-size: 1.2rem; font-weight: bold;">${result.project.name}</div>
                    <div style="color: var(--text-muted);">${result.project.category}</div>
                </div>
                <div style="text-align: center; padding: 0.5rem 1rem; background: var(--bg-surface); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: ${color};">${analysis.coase_score}</div>
                    <div style="font-size: 0.7rem;">ç§‘æ–¯åˆ†æ•°</div>
                </div>
            </div>
            
            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">${result.project.description}</p>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; text-align: center;">
                <div style="padding: 0.5rem; background: var(--bg-surface); border-radius: 4px;">
                    <div style="font-size: 0.7rem; color: var(--text-muted);">ä¸­å¿ƒåŒ–æ”¶ç›Š</div>
                    <div style="font-weight: bold;">${metrics.centralization_benefit}</div>
                </div>
                <div style="padding: 0.5rem; background: var(--bg-surface); border-radius: 4px;">
                    <div style="font-size: 0.7rem; color: var(--text-muted);">ä¸­å¿ƒåŒ–é£é™©</div>
                    <div style="font-weight: bold;">${metrics.centralization_risk}</div>
                </div>
                <div style="padding: 0.5rem; background: var(--bg-surface); border-radius: 4px;">
                    <div style="font-size: 0.7rem; color: var(--text-muted);">å»ä¸­å¿ƒåŒ–æˆæœ¬</div>
                    <div style="font-weight: bold;">${metrics.decentralization_cost}</div>
                </div>
            </div>
        </div>
        
        <div class="message ${analysis.verdict_color}" style="margin-bottom: 1rem;">
            <strong>${analysis.coase_verdict}</strong>
        </div>
        
        <div class="result-box">
            <div class="result-label">åŒ¹é…åº¦æ£€æŸ¥</div>
            ${analysis.mismatch_warning}
        </div>
    `;
    }

    loadProjects();
</script>
{% endblock %}
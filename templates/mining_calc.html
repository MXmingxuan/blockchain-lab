{% extends "base.html" %}

{% block title %}æŒ–çŸ¿ç›ˆäºè®¡ç®—å™¨ - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ’° æŒ–çŸ¿ç›ˆäºè®¡ç®—å™¨</h1>
    <p class="page-subtitle">è®¡ç®—å…³æœºå¸ä»·å’Œæ¯æ—¥åˆ©æ¶¦ - æŒ–çŸ¿ç»æµå­¦åˆ†æ</p>
</div>

<div class="tool-layout">
    <div class="panel">
        <h2 class="panel-title">âš™ï¸ çŸ¿æœºå‚æ•°</h2>

        <div class="input-group">
            <label class="input-label">ç®—åŠ› (TH/s)</label>
            <input type="number" id="hashrate" class="input-field" value="110" min="1">
            <small style="color: var(--text-muted);">å¸¸è§: S19 Pro=110, S21=200</small>
        </div>

        <div class="input-group">
            <label class="input-label">åŠŸè€— (W)</label>
            <input type="number" id="power" class="input-field" value="3250" min="100">
        </div>

        <div class="input-group">
            <label class="input-label">ç”µè´¹ ($/kWh)</label>
            <input type="number" id="electricity" class="input-field" value="0.05" min="0.01" step="0.01">
            <small style="color: var(--text-muted);">ä¸­å›½çº¦$0.03-0.05, ç¾å›½çº¦$0.08-0.12</small>
        </div>

        <div class="input-group">
            <label class="input-label">çŸ¿æ± è´¹ç‡ (%)</label>
            <input type="number" id="poolFee" class="input-field" value="2" min="0" max="10" step="0.1">
        </div>

        <button class="btn btn-primary" onclick="calculate()" style="width: 100%;">
            ğŸ“Š è®¡ç®—ç›ˆäº
        </button>

        <hr style="border-color: var(--border-color); margin: 1.5rem 0;">

        <h3 class="panel-title" style="margin-top: 0;">ğŸ­ å¸¸è§çŸ¿æœºå¯¹æ¯”</h3>
        <button class="btn btn-secondary" onclick="compareMiner('S19Pro')" style="margin: 0.25rem;">S19 Pro</button>
        <button class="btn btn-secondary" onclick="compareMiner('S21')" style="margin: 0.25rem;">S21</button>
        <button class="btn btn-secondary" onclick="compareMiner('M50S')" style="margin: 0.25rem;">M50S</button>
    </div>

    <div class="panel">
        <h2 class="panel-title">ğŸ“ˆ ç›ˆäºåˆ†æ</h2>

        <div id="results" style="display: none;">
            <div id="profitStatus"></div>

            <div class="stats-grid" style="margin-top: 1rem;">
                <div class="stat-item">
                    <div class="stat-value" id="dailyProfit">$0</div>
                    <div class="stat-label">æ¯æ—¥åˆ©æ¶¦</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="shutdownPrice">$0</div>
                    <div class="stat-label">å…³æœºå¸ä»·</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="margin">0%</div>
                    <div class="stat-label">åˆ©æ¶¦ç‡</div>
                </div>
            </div>

            <div class="result-box" style="margin-top: 1.5rem;">
                <div class="result-label">æ¯æ—¥æ˜ç»†</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                    <div>äº§å‡º BTC:</div>
                    <div id="dailyBtc">-</div>
                    <div>æ”¶å…¥:</div>
                    <div id="dailyRevenue">-</div>
                    <div>ç”µè´¹:</div>
                    <div id="dailyCost">-</div>
                </div>
            </div>

            <div class="result-box">
                <div class="result-label">å¸‚åœºæ•°æ®</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                    <div>BTC ä»·æ ¼:</div>
                    <div id="btcPrice">-</div>
                    <div>å…¨ç½‘éš¾åº¦:</div>
                    <div id="difficulty">-</div>
                    <div>åŒºå—å¥–åŠ±:</div>
                    <div id="blockReward">-</div>
                    <div>æ•°æ®æ¥æº:</div>
                    <div id="dataSource">-</div>
                </div>
            </div>
        </div>

        <div id="placeholder" class="message info">
            ğŸ‘† è¾“å…¥çŸ¿æœºå‚æ•°åç‚¹å‡»è®¡ç®—
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const miners = {
        'S19Pro': { hashrate: 110, power: 3250 },
        'S21': { hashrate: 200, power: 3500 },
        'M50S': { hashrate: 126, power: 3276 }
    };

    function compareMiner(model) {
        const miner = miners[model];
        document.getElementById('hashrate').value = miner.hashrate;
        document.getElementById('power').value = miner.power;
        calculate();
    }

    async function calculate() {
        const hashrate = parseFloat(document.getElementById('hashrate').value);
        const power = parseInt(document.getElementById('power').value);
        const electricity = parseFloat(document.getElementById('electricity').value);
        const poolFee = parseFloat(document.getElementById('poolFee').value);

        const response = await fetch('/api/mining/calculate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                hashrate_th: hashrate,
                power_watts: power,
                electricity_cost: electricity,
                pool_fee_percent: poolFee
            })
        });

        const data = await response.json();

        document.getElementById('results').style.display = 'block';
        document.getElementById('placeholder').style.display = 'none';

        const profitable = data.breakeven.profitable;
        document.getElementById('profitStatus').innerHTML = profitable
            ? '<div class="validation-status valid">âœ… å½“å‰ç›ˆåˆ©</div>'
            : '<div class="validation-status invalid">âŒ å½“å‰äºæŸ</div>';

        document.getElementById('dailyProfit').textContent = '$' + data.daily_mining.profit_usd.toFixed(2);
        document.getElementById('dailyProfit').style.color = profitable ? 'var(--accent-green)' : 'var(--accent-red)';

        document.getElementById('shutdownPrice').textContent = '$' + data.breakeven.shutdown_price.toLocaleString();
        document.getElementById('margin').textContent = data.breakeven.current_margin + '%';

        document.getElementById('dailyBtc').textContent = data.daily_mining.btc_after_fee.toFixed(8) + ' BTC';
        document.getElementById('dailyRevenue').textContent = '$' + data.daily_mining.revenue_usd.toFixed(2);
        document.getElementById('dailyCost').textContent = '$' + data.daily_mining.electricity_cost.toFixed(2);

        document.getElementById('btcPrice').textContent = '$' + data.market_data.btc_price.toLocaleString();
        document.getElementById('difficulty').textContent = (data.market_data.difficulty / 1e12).toFixed(2) + ' T';
        document.getElementById('blockReward').textContent = data.market_data.block_reward + ' BTC';
        document.getElementById('dataSource').textContent = data.market_data.data_source;
    }
</script>
{% endblock %}
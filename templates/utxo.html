{% extends "base.html" %}

{% block title %}UTXO å¯è§†åŒ– - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ“¦ UTXO æ¨¡å‹å¯è§†åŒ–</h1>
    <p class="page-subtitle">ç†è§£æ¯”ç‰¹å¸çš„"ç¡¬å¸"æ¨¡å‹ - ä½™é¢ = æ‰€æœ‰æœªèŠ±è´¹è¾“å‡ºä¹‹å’Œ</p>
</div>

<div class="tool-layout">
    <div class="panel">
        <h2 class="panel-title">ğŸ” æŸ¥è¯¢åœ°å€ UTXO</h2>

        <div class="input-group">
            <label class="input-label">æ¯”ç‰¹å¸åœ°å€</label>
            <input type="text" id="address" class="input-field" placeholder="è¾“å…¥æ¯”ç‰¹å¸åœ°å€æˆ–ç•™ç©ºä½¿ç”¨æ¼”ç¤ºæ•°æ®">
        </div>

        <button class="btn btn-primary" onclick="queryUTXOs()" style="width: 100%;">
            ğŸ” æŸ¥è¯¢ UTXO
        </button>

        <div id="queryResult" style="margin-top: 1.5rem;"></div>

        <hr style="border-color: var(--border-color); margin: 1.5rem 0;">

        <h3 class="panel-title" style="margin-top: 0;">ğŸ’¸ æ¨¡æ‹Ÿè½¬è´¦</h3>

        <div class="input-group">
            <label class="input-label">å‘é€é‡‘é¢ (BTC)</label>
            <input type="number" id="sendAmount" class="input-field" value="1.5" step="0.01" min="0">
        </div>

        <button class="btn btn-secondary" onclick="simulateTransfer()" style="width: 100%;">
            âš¡ æ¨¡æ‹Ÿé€‰å¸
        </button>

        <div id="transferResult" style="margin-top: 1rem;"></div>
    </div>

    <div class="panel">
        <h2 class="panel-title">ğŸª™ UTXO ç¡¬å¸è§†å›¾</h2>

        <div id="coinsView">
            <div class="message info">
                æŸ¥è¯¢åœ°å€åï¼ŒUTXO å°†æ˜¾ç¤ºä¸º"ç¡¬å¸"
            </div>
        </div>

        <hr style="border-color: var(--border-color); margin: 1.5rem 0;">

        <div class="message info">
            <strong>ğŸ’¡ UTXO æ¨¡å‹æ ¸å¿ƒæ¦‚å¿µ</strong>
            <ul style="margin-top: 0.5rem; color: var(--text-secondary); padding-left: 1.5rem;">
                <li><strong>è¾“å…¥ = ä¹‹å‰çš„è¾“å‡º</strong>ï¼šæ¯ç¬”äº¤æ˜“çš„è¾“å…¥å¿…é¡»å¼•ç”¨ä¹‹å‰çš„æœªèŠ±è´¹è¾“å‡º</li>
                <li><strong>å®Œå…¨æ¶ˆè€—</strong>ï¼šUTXO ä¸€æ—¦è¢«èŠ±è´¹å°±å®Œå…¨é”€æ¯</li>
                <li><strong>æ‰¾é›¶æœºåˆ¶</strong>ï¼šå¤šä½™çš„é‡‘é¢ä¼šä½œä¸ºæ–° UTXO è¿”å›ç»™è‡ªå·±</li>
                <li><strong>å¹¶è¡ŒéªŒè¯</strong>ï¼šä¸åŒ UTXO å¯ä»¥å¹¶è¡ŒéªŒè¯ï¼Œæé«˜æ€§èƒ½</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentUTXOs = [];

    async function queryUTXOs() {
        const address = document.getElementById('address').value;

        document.getElementById('queryResult').innerHTML =
            '<div class="message">æ­£åœ¨æŸ¥è¯¢...</div>';

        try {
            const response = await fetch('/api/utxo/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address })
            });
            const data = await response.json();

            if (data.success) {
                currentUTXOs = data.utxos;

                document.getElementById('queryResult').innerHTML = `
                <div class="result-box">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div class="result-label">UTXO æ•°é‡</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">${data.utxo_count}</div>
                        </div>
                        <div>
                            <div class="result-label">æ€»ä½™é¢</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-green);">
                                ${data.total_btc.toFixed(8)} BTC
                            </div>
                        </div>
                    </div>
                    ${data.is_mock ? '<div style="margin-top: 0.5rem; color: var(--accent-orange);">âš ï¸ ä½¿ç”¨æ¼”ç¤ºæ•°æ®</div>' : ''}
                </div>`;

                renderCoins(data.coins);
            }
        } catch (error) {
            document.getElementById('queryResult').innerHTML =
                `<div class="message error">æŸ¥è¯¢å¤±è´¥: ${error.message}</div>`;
        }
    }

    function renderCoins(coins) {
        if (!coins || coins.length === 0) {
            document.getElementById('coinsView').innerHTML =
                '<div class="message">æ²¡æœ‰ UTXO</div>';
            return;
        }

        let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';

        coins.forEach(coin => {
            let bgColor = coin.size === 'large' ? 'var(--accent-green)' :
                coin.size === 'medium' ? 'var(--accent-blue)' :
                    coin.size === 'small' ? 'var(--accent-orange)' : 'var(--text-muted)';

            html += `
            <div class="result-box" style="border-left: 4px solid ${bgColor}; padding: 0.75rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 1.5rem;">${coin.emoji}</span>
                    <span style="font-weight: bold; color: ${bgColor};">${coin.value_btc.toFixed(8)} BTC</span>
                </div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
                    TX: ${coin.tx_hash_short} | ç¡®è®¤: ${coin.confirmations}
                </div>
            </div>`;
        });

        html += '</div>';
        document.getElementById('coinsView').innerHTML = html;
    }

    async function simulateTransfer() {
        if (currentUTXOs.length === 0) {
            document.getElementById('transferResult').innerHTML =
                '<div class="message warning">è¯·å…ˆæŸ¥è¯¢ UTXO</div>';
            return;
        }

        const amount = parseFloat(document.getElementById('sendAmount').value);

        try {
            const response = await fetch('/api/utxo/select', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ utxos: currentUTXOs, amount_btc: amount })
            });
            const data = await response.json();

            if (data.success) {
                document.getElementById('transferResult').innerHTML = `
                <div class="result-box">
                    <div class="result-label">é€‰å¸ç»“æœ</div>
                    <div style="margin-top: 0.5rem;">
                        <div>é€‰ä¸­ <strong>${data.selected_count}</strong> ä¸ª UTXO</div>
                        <div>æ€»è¾“å…¥: <strong>${data.total_input_btc.toFixed(8)} BTC</strong></div>
                        <div>æ”¯ä»˜: ${amount.toFixed(8)} BTC</div>
                        <div>æ‰¾é›¶: <span style="color: var(--accent-orange);">${data.change_btc.toFixed(8)} BTC</span></div>
                        <div>æ‰‹ç»­è´¹: ${data.fee_btc.toFixed(8)} BTC</div>
                    </div>
                </div>`;
            } else {
                document.getElementById('transferResult').innerHTML =
                    `<div class="message error">${data.error}</div>`;
            }
        } catch (error) {
            document.getElementById('transferResult').innerHTML =
                `<div class="message error">æ¨¡æ‹Ÿå¤±è´¥: ${error.message}</div>`;
        }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æŸ¥è¯¢æ¼”ç¤ºæ•°æ®
    queryUTXOs();
</script>
{% endblock %}
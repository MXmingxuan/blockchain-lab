{% extends "base.html" %}

{% block title %}è¿·ä½ åŒºå—é“¾æ„å»ºå™¨ - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">â›“ï¸ è¿·ä½ åŒºå—é“¾æ„å»ºå™¨</h1>
    <p class="page-subtitle">ç†è§£åŒºå—å¦‚ä½•é€šè¿‡å“ˆå¸ŒæŒ‡é’ˆé“¾æ¥ - ä¸å¯ç¯¡æ”¹æ€§çš„æ¥æº</p>
</div>

<div class="tool-layout">
    <div class="panel">
        <h2 class="panel-title">ğŸ› ï¸ æ“ä½œ</h2>

        <div class="input-group">
            <label class="input-label">æ–°åŒºå—æ•°æ®</label>
            <input type="text" id="blockData" class="input-field" placeholder="ä¾‹å¦‚ï¼šAlice pays Bob 1 BTC">
        </div>

        <div class="btn-group">
            <button class="btn btn-primary" onclick="addBlock()">
                â• æ·»åŠ åŒºå—
            </button>
            <button class="btn btn-secondary" onclick="resetChain()">
                ğŸ”„ é‡ç½®é“¾
            </button>
        </div>

        <hr style="border-color: var(--border-color); margin: 1.5rem 0;">

        <h3 class="panel-title" style="margin-top: 0;">âš ï¸ ç¯¡æ”¹æµ‹è¯•</h3>

        <div class="input-group">
            <label class="input-label">è¦ç¯¡æ”¹çš„åŒºå—ç´¢å¼•</label>
            <input type="number" id="tamperIndex" class="input-field" value="1" min="0">
        </div>

        <div class="input-group">
            <label class="input-label">ç¯¡æ”¹åçš„æ•°æ®</label>
            <input type="text" id="tamperData" class="input-field" placeholder="ä¾‹å¦‚ï¼šAlice pays Bob 100 BTC">
        </div>

        <button class="btn btn-danger" onclick="tamperBlock()">
            ğŸ’€ ç¯¡æ”¹åŒºå—
        </button>

        <div class="message info" style="margin-top: 1rem;">
            ğŸ’¡ å°è¯•ç¯¡æ”¹åè§‚å¯ŸéªŒè¯çŠ¶æ€å˜åŒ–
        </div>
    </div>

    <div class="panel">
        <h2 class="panel-title">ğŸ“¦ åŒºå—é“¾çŠ¶æ€</h2>

        <div id="validationStatus"></div>

        <div id="blockchainVisual" class="blockchain-visual"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadChain() {
        const response = await fetch('/api/blockchain/chain');
        const data = await response.json();
        renderChain(data.chain, data.valid);
    }

    function renderChain(chain, validation) {
        const container = document.getElementById('blockchainVisual');
        const statusDiv = document.getElementById('validationStatus');

        // æ¸²æŸ“éªŒè¯çŠ¶æ€
        if (validation.valid) {
            statusDiv.innerHTML = `
            <div class="validation-status valid">
                âœ… åŒºå—é“¾å®Œæ•´ - å·²éªŒè¯ ${validation.checked_blocks} ä¸ªåŒºå—
            </div>`;
        } else {
            statusDiv.innerHTML = `
            <div class="validation-status invalid">
                âŒ åŒºå—é“¾å·²æŸåï¼
                <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                    ${validation.errors.map(e => `<li>${e}</li>`).join('')}
                </ul>
            </div>`;
        }

        // æ¸²æŸ“åŒºå—
        let html = '';
        chain.forEach((block, index) => {
            const isGenesis = block.index === 0;
            const isInvalid = validation.errors && validation.errors.some(e => e.includes(`åŒºå— ${block.index}`));

            if (index > 0) {
                html += '<div class="block-connector">â†“</div>';
            }

            html += `
            <div class="block-card ${isGenesis ? 'genesis' : ''} ${isInvalid ? 'invalid' : ''} fade-in">
                <div class="block-header">
                    <span class="block-index">${isGenesis ? 'ğŸŒŸ åˆ›ä¸–åŒºå—' : 'åŒºå— #' + block.index}</span>
                    <span class="block-time">${new Date(block.timestamp * 1000).toLocaleTimeString()}</span>
                </div>
                <div class="block-data">${block.data}</div>
                <div class="block-hash">
                    <div>å‰å—: ${block.previous_hash.substring(0, 20)}...</div>
                    <div>å½“å‰: ${block.hash.substring(0, 20)}...</div>
                </div>
            </div>`;
        });

        container.innerHTML = html;
    }

    async function addBlock() {
        const data = document.getElementById('blockData').value || 'Empty Block';

        await fetch('/api/blockchain/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data })
        });

        document.getElementById('blockData').value = '';
        loadChain();
    }

    async function tamperBlock() {
        const index = parseInt(document.getElementById('tamperIndex').value);
        const data = document.getElementById('tamperData').value || 'Tampered!';

        await fetch('/api/blockchain/tamper', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ index, data })
        });

        loadChain();
    }

    async function resetChain() {
        await fetch('/api/blockchain/reset', { method: 'POST' });
        loadChain();
    }

    // é¡µé¢åŠ è½½æ—¶è·å–é“¾æ•°æ®
    loadChain();
</script>
{% endblock %}
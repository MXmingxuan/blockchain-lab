{% extends "base.html" %}

{% block title %}è„šæœ¬æ¨¡æ‹Ÿå™¨ - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ“œ æ¯”ç‰¹å¸è„šæœ¬æ¨¡æ‹Ÿå™¨</h1>
    <p class="page-subtitle">ç†è§£å †æ ˆå¼è„šæœ¬è¯­è¨€ - æ¯”ç‰¹å¸çš„"æ™ºèƒ½åˆçº¦"</p>
</div>

<div class="tool-layout">
    <div class="panel">
        <h2 class="panel-title">ğŸ¯ è„šæœ¬ç±»å‹</h2>

        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            <button class="btn btn-primary" onclick="runP2PKH(true)" style="width: 100%;">
                â–¶ï¸ è¿è¡Œ P2PKH (æœ‰æ•ˆç­¾å)
            </button>
            <button class="btn btn-secondary" onclick="runP2PKH(false)" style="width: 100%;">
                âŒ è¿è¡Œ P2PKH (æ— æ•ˆç­¾å)
            </button>
        </div>

        <hr style="border-color: var(--border-color); margin: 1.5rem 0;">

        <h3 class="panel-title" style="margin-top: 0;">ğŸ“‹ P2PKH è„šæœ¬ç»“æ„</h3>

        <div class="result-box" style="font-family: monospace; font-size: 0.85rem;">
            <div class="result-label">è§£é”è„šæœ¬ (ScriptSig)</div>
            <div style="color: var(--accent-blue);">&lt;Signature&gt; &lt;PublicKey&gt;</div>
        </div>

        <div class="result-box" style="font-family: monospace; font-size: 0.85rem; margin-top: 0.5rem;">
            <div class="result-label">é”å®šè„šæœ¬ (ScriptPubKey)</div>
            <div style="color: var(--accent-purple);">
                OP_DUP OP_HASH160 &lt;PubKeyHash&gt; OP_EQUALVERIFY OP_CHECKSIG
            </div>
        </div>

        <hr style="border-color: var(--border-color); margin: 1.5rem 0;">

        <h3 class="panel-title" style="margin-top: 0;">ğŸ“– æ“ä½œç å‚è€ƒ</h3>
        <div id="opcodeRef"></div>
    </div>

    <div class="panel">
        <h2 class="panel-title">âš™ï¸ æ‰§è¡Œè¿‡ç¨‹</h2>

        <div id="executionTrace">
            <div class="message info">
                ç‚¹å‡»"è¿è¡Œ"æŒ‰é’®è§‚å¯Ÿè„šæœ¬æ‰§è¡Œè¿‡ç¨‹
            </div>
        </div>

        <div id="executionResult" style="margin-top: 1rem;"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function runP2PKH(validSig) {
        document.getElementById('executionTrace').innerHTML =
            '<div class="message">æ­£åœ¨æ‰§è¡Œ...</div>';

        try {
            const response = await fetch('/api/script/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ script_type: 'p2pkh', valid_sig: validSig })
            });
            const data = await response.json();

            renderTrace(data.trace);

            let resultColor = data.success ? 'var(--accent-green)' : 'var(--accent-red)';
            let resultIcon = data.success ? 'âœ…' : 'âŒ';

            document.getElementById('executionResult').innerHTML = `
            <div class="result-box" style="border-left: 4px solid ${resultColor};">
                <div style="font-size: 1.25rem; font-weight: bold;">
                    ${resultIcon} æ‰§è¡Œç»“æœ: ${data.success ? 'æˆåŠŸ' : 'å¤±è´¥'}
                </div>
                <div style="margin-top: 0.5rem; color: var(--text-secondary);">
                    æ€»æ­¥éª¤: ${data.total_steps}
                </div>
                <div style="font-family: monospace; margin-top: 0.5rem;">
                    æœ€ç»ˆå †æ ˆ: [${data.final_stack.join(', ') || 'ç©º'}]
                </div>
            </div>`;

        } catch (error) {
            document.getElementById('executionTrace').innerHTML =
                `<div class="message error">æ‰§è¡Œå¤±è´¥: ${error.message}</div>`;
        }
    }

    function renderTrace(trace) {
        if (!trace || trace.length === 0) {
            document.getElementById('executionTrace').innerHTML =
                '<div class="message">æ²¡æœ‰æ‰§è¡Œè®°å½•</div>';
            return;
        }

        let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';

        trace.forEach(step => {
            let opColor = step.operation.startsWith('OP_') ? 'var(--accent-purple)' : 'var(--accent-blue)';

            html += `
            <div class="flow-step">
                <div class="step-number">${step.step}</div>
                <div class="step-content">
                    <div class="step-title" style="color: ${opColor};">${step.operation}</div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">${step.description}</div>
                    <div style="font-family: monospace; font-size: 0.8rem; margin-top: 0.25rem; color: var(--text-muted);">
                        å †æ ˆ: [${step.stack_after.join(', ') || 'ç©º'}]
                    </div>
                </div>
            </div>`;
        });

        html += '</div>';
        document.getElementById('executionTrace').innerHTML = html;
    }

    async function loadOpcodeRef() {
        try {
            const response = await fetch('/api/script/opcodes');
            const data = await response.json();

            let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';

            data.forEach(op => {
                html += `
                <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--surface); border-radius: 4px;">
                    <span style="font-family: monospace; color: var(--accent-purple);">${op.opcode}</span>
                    <span style="color: var(--text-secondary); font-size: 0.85rem;">${op.description}</span>
                </div>`;
            });

            html += '</div>';
            document.getElementById('opcodeRef').innerHTML = html;
        } catch (error) {
            console.error('åŠ è½½æ“ä½œç å¤±è´¥:', error);
        }
    }

    // é¡µé¢åŠ è½½æ—¶åŠ è½½æ“ä½œç å‚è€ƒ
    loadOpcodeRef();
</script>
{% endblock %}
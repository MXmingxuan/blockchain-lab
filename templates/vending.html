{% extends "base.html" %}

{% block title %}æ™ºèƒ½åˆçº¦å”®è´§æœº - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ° æ™ºèƒ½åˆçº¦å”®è´§æœº</h1>
    <p class="page-subtitle">ä½“éªŒ"å±¥çº¦æ¢å±¥çº¦"çš„æ™ºèƒ½åˆçº¦æœ¬è´¨ â€” Larry Lessig çš„è‡ªåŠ¨å”®è´§æœºæ¯”å–»</p>
</div>

<div class="tool-layout">
    <!-- å·¦ä¾§ï¼šå”®è´§æœºç•Œé¢ -->
    <div class="panel">
        <h3 class="panel-title">ğŸ­ è‡ªåŠ¨å”®è´§æœº</h3>

        <div id="machineStatus" style="margin-bottom: 1.5rem;">
            <div
                style="display: flex; justify-content: space-between; padding: 1rem; background: var(--bg-subtle); border-radius: 8px;">
                <div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">åˆçº¦ä½™é¢</div>
                    <div id="contractBalance" style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">0.000
                        ETH</div>
                </div>
                <div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">äº¤æ˜“æ¬¡æ•°</div>
                    <div id="txCount" style="font-size: 1.5rem; font-weight: bold;">0</div>
                </div>
            </div>
        </div>

        <div id="products"
            style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
            <!-- å•†å“å°†é€šè¿‡ JS åŠ¨æ€åŠ è½½ -->
        </div>

        <div class="input-group">
            <label class="input-label">æŠ•å…¥é‡‘é¢ (ETH)</label>
            <input type="number" id="depositAmount" class="input-field" step="0.0001" value="0.002" min="0">
        </div>

        <div class="input-group">
            <label class="input-label">é€‰æ‹©å•†å“</label>
            <select id="selectedProduct" class="input-field">
                <!-- åŠ¨æ€åŠ è½½ -->
            </select>
        </div>

        <button class="btn btn-primary" onclick="purchaseProduct()" style="width: 100%;">
            ğŸª™ æŠ•å¸è´­ä¹°
        </button>
    </div>

    <!-- å³ä¾§ï¼šäº¤æ˜“æ—¥å¿— -->
    <div class="panel">
        <h3 class="panel-title">ğŸ“œ äº¤æ˜“æ—¥å¿—</h3>

        <div id="transactionLog" style="max-height: 400px; overflow-y: auto;">
            <div class="message info">
                ç‚¹å‡»"æŠ•å¸è´­ä¹°"å¼€å§‹ä½“éªŒæ™ºèƒ½åˆçº¦çš„æ‰§è¡Œè¿‡ç¨‹
            </div>
        </div>

        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-subtle); border-radius: 8px;">
            <h4 style="margin-bottom: 0.5rem;">ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ</h4>
            <ul style="font-size: 0.9rem; color: var(--text-secondary); padding-left: 1.2rem;">
                <li><strong>çŠ¶æ€å˜é‡</strong>: balance, inventory</li>
                <li><strong>æ¡ä»¶æ£€æŸ¥</strong>: é‡‘é¢è¶³å¤Ÿ? åº“å­˜å……è¶³?</li>
                <li><strong>Revert</strong>: æ¡ä»¶ä¸æ»¡è¶³æ—¶å›æ»š</li>
                <li><strong>åŸå­æ€§</strong>: è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥</li>
            </ul>
        </div>
    </div>
</div>

<script>
    let machineState = null;

    async function loadMachine() {
        const response = await fetch('/api/vending/status');
        const data = await response.json();
        machineState = data.machine;

        // æ›´æ–°ä½™é¢
        document.getElementById('contractBalance').textContent = machineState.balance.toFixed(6) + ' ETH';
        document.getElementById('txCount').textContent = machineState.transaction_count;

        // æ¸²æŸ“å•†å“
        const productsDiv = document.getElementById('products');
        const select = document.getElementById('selectedProduct');
        productsDiv.innerHTML = '';
        select.innerHTML = '';

        for (const [id, product] of Object.entries(machineState.products)) {
            // å•†å“å¡ç‰‡
            productsDiv.innerHTML += `
            <div style="padding: 1rem; background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: 8px; text-align: center;">
                <div style="font-size: 2rem;">${product.emoji}</div>
                <div style="font-weight: bold;">${product.name}</div>
                <div style="color: var(--primary);">${product.price} ETH</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">åº“å­˜: ${product.stock}</div>
            </div>
        `;

            // ä¸‹æ‹‰é€‰é¡¹
            select.innerHTML += `<option value="${id}">${product.emoji} ${product.name} (${product.price} ETH)</option>`;
        }
    }

    async function purchaseProduct() {
        const productId = document.getElementById('selectedProduct').value;
        const amount = parseFloat(document.getElementById('depositAmount').value);

        const response = await fetch('/api/vending/purchase', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ product_id: productId, amount: amount })
        });

        const result = await response.json();

        // æ·»åŠ åˆ°æ—¥å¿—
        const logDiv = document.getElementById('transactionLog');
        const tx = result.transaction;

        const logEntry = document.createElement('div');
        logEntry.className = 'result-box';
        logEntry.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span style="font-weight: bold;">${tx.result}</span>
            <span style="color: var(--text-muted); font-size: 0.8rem;">${tx.timestamp}</span>
        </div>
        <div style="font-size: 0.9rem;">${tx.details}</div>
    `;

        logDiv.innerHTML = '';
        logDiv.prepend(logEntry);

        // åˆ·æ–°çŠ¶æ€
        loadMachine();
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    loadMachine();
</script>
{% endblock %}
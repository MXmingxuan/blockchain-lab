{% extends "base.html" %}

{% block title %}é»˜å…‹å°”æ ‘è®¡ç®—å™¨ - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸŒ² é»˜å…‹å°”æ ‘è®¡ç®—å™¨</h1>
    <p class="page-subtitle">å°†å¤šç¬”äº¤æ˜“å‹ç¼©æˆå•ä¸€æ ¹å“ˆå¸Œ - è½»èŠ‚ç‚¹éªŒè¯çš„åŸºç¡€</p>
</div>

<div class="tool-layout">
    <div class="panel">
        <h2 class="panel-title">ğŸ“ è¾“å…¥äº¤æ˜“</h2>

        <div class="input-group">
            <label class="input-label">äº¤æ˜“åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ç¬”ï¼‰</label>
            <textarea id="transactions" class="input-field" rows="6"
                placeholder="Alice -> Bob: 1 BTC&#10;Bob -> Charlie: 0.5 BTC&#10;Charlie -> David: 0.3 BTC&#10;David -> Eve: 0.1 BTC">Alice -> Bob: 1 BTC
Bob -> Charlie: 0.5 BTC
Charlie -> David: 0.3 BTC
David -> Eve: 0.1 BTC</textarea>
        </div>

        <button class="btn btn-primary" onclick="buildTree()">
            ğŸŒ² æ„å»ºé»˜å…‹å°”æ ‘
        </button>

        <div class="message info" style="margin-top: 1.5rem;">
            ğŸ’¡ è¾“å…¥ 2ã€4 æˆ– 8 ç¬”äº¤æ˜“å¯ä»¥å¾—åˆ°å®Œç¾çš„äºŒå‰æ ‘ç»“æ„
        </div>
    </div>

    <div class="panel">
        <h2 class="panel-title">ğŸŒ³ æ ‘ç»“æ„</h2>

        <div id="merkleRoot" style="display: none;">
            <div class="result-box">
                <div class="result-label">é»˜å…‹å°”æ ¹ (Merkle Root)</div>
                <div class="result-value" id="rootHash"></div>
            </div>
        </div>

        <div id="merkleTree" class="merkle-tree" style="margin-top: 1.5rem;"></div>

        <div id="placeholder" class="message info">
            ğŸ‘† è¾“å…¥äº¤æ˜“å¹¶ç‚¹å‡»æ„å»ºæŒ‰é’®æŸ¥çœ‹æ ‘ç»“æ„
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function buildTree() {
        const textarea = document.getElementById('transactions');
        const transactions = textarea.value.split('\n').filter(t => t.trim());

        if (transactions.length < 2) {
            alert('è¯·è‡³å°‘è¾“å…¥ 2 ç¬”äº¤æ˜“');
            return;
        }

        const response = await fetch('/api/merkle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ transactions })
        });

        const data = await response.json();

        // æ˜¾ç¤ºæ ¹å“ˆå¸Œ
        document.getElementById('rootHash').textContent = data.merkle_root;
        document.getElementById('merkleRoot').style.display = 'block';

        // æ¸²æŸ“æ ‘ç»“æ„
        renderTree(data.levels);

        document.getElementById('placeholder').style.display = 'none';
    }

    function renderTree(levels) {
        const container = document.getElementById('merkleTree');
        let html = '';

        levels.forEach((level, levelIndex) => {
            const isRoot = levelIndex === 0;
            const isLeaf = levelIndex === levels.length - 1;

            html += '<div class="merkle-level">';

            level.forEach(node => {
                const nodeClass = isRoot ? 'root' : (isLeaf ? 'leaf' : '');

                html += `
                <div class="merkle-node ${nodeClass} fade-in">
                    <div class="merkle-hash">${node.hash.substring(0, 12)}...</div>
                    ${node.data ? `<div class="merkle-data">${node.data}</div>` : ''}
                </div>`;
            });

            html += '</div>';

            // æ·»åŠ è¿æ¥çº¿ï¼ˆé™¤äº†æœ€åä¸€å±‚ï¼‰
            if (levelIndex < levels.length - 1) {
                html += '<div style="text-align: center; color: var(--accent-green); font-size: 1.2rem;">â†“</div>';
            }
        });

        container.innerHTML = html;
    }
</script>
{% endblock %}
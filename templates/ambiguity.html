{% extends "base.html" %}

{% block title %}æ³•å¾‹æ¨¡ç³Šæ€§å†³ç­–æ ‘ - åŒºå—é“¾å¯†ç å­¦å·¥å…·{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸŒ³ æ³•å¾‹æ¨¡ç³Šæ€§å†³ç­–æ ‘</h1>
    <p class="page-subtitle">ä»£ç ç²¾ç¡®æ€§ vs æ³•å¾‹æ¨¡ç³Šæ€§ â€” Lessig æ•™æˆçš„æ´è§</p>
</div>

<div class="tool-layout">
    <!-- å·¦ä¾§ï¼šåœºæ™¯é€‰æ‹© -->
    <div class="panel">
        <h3 class="panel-title">ğŸ“‹ é€‰æ‹©åˆçº¦åœºæ™¯</h3>

        <div class="result-box" style="margin-bottom: 1rem;">
            <div class="result-label">Lessig æ•™æˆçš„è§‚ç‚¹</div>
            <div style="font-size: 0.95rem; font-style: italic;">
                "æ³•å¾‹å…è®¸æ¨¡ç³Šæ€§ä»¥é™ä½è°ˆåˆ¤æˆæœ¬ï¼Œä½†ä»£ç è¦æ±‚ç»å¯¹ç²¾ç¡®ã€‚"
            </div>
        </div>

        <div id="scenarios" style="margin-bottom: 1.5rem;">
            <!-- åŠ¨æ€åŠ è½½åœºæ™¯ -->
        </div>

        <div class="input-group">
            <label class="input-label">æ˜¾ç¤ºæ·±åº¦</label>
            <select id="depth" class="input-field">
                <option value="2">ç®€åŒ– (2å±‚)</option>
                <option value="3" selected>æ ‡å‡† (3å±‚)</option>
                <option value="5">å®Œæ•´ (5å±‚)</option>
            </select>
        </div>

        <button class="btn btn-primary" onclick="generateTree()" style="width: 100%;">
            ğŸŒ² ç”Ÿæˆå†³ç­–æ ‘
        </button>
    </div>

    <!-- å³ä¾§ï¼šå†³ç­–æ ‘å¯è§†åŒ– -->
    <div class="panel">
        <h3 class="panel-title">ğŸ”€ è¾¹ç¼˜æ¡ˆä¾‹åˆ†æ</h3>

        <div id="treeResult">
            <div class="message info">é€‰æ‹©ä¸€ä¸ªåˆçº¦åœºæ™¯ï¼ŒæŸ¥çœ‹éœ€è¦å¤„ç†çš„è¾¹ç¼˜æ¡ˆä¾‹</div>
        </div>

        <div id="statistics" style="margin-top: 1.5rem; display: none;">
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        </div>

        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-subtle); border-radius: 8px;">
            <h4 style="margin-bottom: 0.5rem;">ğŸ’¡ ä¸ºä»€ä¹ˆæ™ºèƒ½åˆçº¦å—é™ï¼Ÿ</h4>
            <p style="font-size: 0.9rem; color: var(--text-secondary);">
                è¯•å›¾ç”¨ä»£ç è¦†ç›–æ‰€æœ‰è¾¹ç¼˜æƒ…å†µä¼šå¯¼è‡´åˆçº¦å˜å¾—ä¸å¯è¡Œçš„å¤æ‚ã€‚<br>
                è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ™ºèƒ½åˆçº¦ç›®å‰ä¸»è¦ç”¨äº<strong>ç®€å•ã€å‚æ•°æ¸…æ™°</strong>çš„åœºæ™¯ï¼ˆå¦‚åšå½©ã€ç®€å•é‡‘èè¡ç”Ÿå“ï¼‰ã€‚
            </p>
        </div>
    </div>
</div>

<script>
    let selectedScenario = null;

    async function loadScenarios() {
        const response = await fetch('/api/ambiguity/scenarios');
        const scenarios = await response.json();

        const container = document.getElementById('scenarios');
        container.innerHTML = '';

        scenarios.forEach(s => {
            const item = document.createElement('div');
            item.style.cssText = 'padding: 1rem; border: 1px solid var(--border-subtle); border-radius: 8px; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s;';
            item.id = `scenario-${s.id}`;

            item.onclick = () => {
                // æ¸…é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('[id^="scenario-"]').forEach(el => {
                    el.style.borderColor = 'var(--border-subtle)';
                    el.style.background = 'transparent';
                });
                // è®¾ç½®å½“å‰é€‰ä¸­
                item.style.borderColor = 'var(--primary)';
                item.style.background = 'var(--bg-subtle)';
                selectedScenario = s.id;
            };

            item.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: bold;">${s.name}</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">${s.base_logic}</div>
                </div>
                <div style="text-align: center; padding: 0.25rem 0.75rem; background: var(--primary-light); border-radius: 4px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);">${s.edge_case_count}</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted);">è¾¹ç¼˜æ¡ˆä¾‹</div>
                </div>
            </div>
        `;

            container.appendChild(item);
        });
    }

    async function generateTree() {
        if (!selectedScenario) {
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåˆçº¦åœºæ™¯');
            return;
        }

        const depth = document.getElementById('depth').value;

        const response = await fetch(`/api/ambiguity/generate?scenario=${selectedScenario}&depth=${depth}`);
        const result = await response.json();

        if (result.error) {
            document.getElementById('treeResult').innerHTML = `<div class="message error">${result.error}</div>`;
            return;
        }

        // æ¸²æŸ“å†³ç­–æ ‘
        let treeHtml = `
        <div class="result-box" style="margin-bottom: 1rem;">
            <div style="font-weight: bold; margin-bottom: 0.5rem;">${result.scenario.name}</div>
            <div style="font-size: 0.9rem; color: var(--success); margin-bottom: 1rem;">
                âœ… åŸºç¡€é€»è¾‘: ${result.scenario.base_logic}
            </div>
            
            <div style="font-size: 0.85rem;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; color: var(--danger);">â“ ä½†æ˜¯å¦‚æœ...</div>
    `;

        result.tree.filter(n => n.type === 'edge_case').forEach(node => {
            const complexityBar = 'â–ˆ'.repeat(node.complexity) + 'â–‘'.repeat(5 - node.complexity);
            treeHtml += `
            <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: var(--bg-surface); border-left: 3px solid var(--warning); border-radius: 0 4px 4px 0;">
                <div style="display: flex; justify-content: space-between;">
                    <span>${node.content}</span>
                    <span style="font-size: 0.75rem; color: var(--text-muted);">${node.probability}</span>
                </div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">
                    å¤æ‚åº¦: ${complexityBar}
                </div>
            </div>
        `;
        });

        treeHtml += `</div></div>`;

        document.getElementById('treeResult').innerHTML = treeHtml;

        // æ˜¾ç¤ºç»Ÿè®¡
        const stats = result.statistics;
        const statsDiv = document.getElementById('statistics');
        statsDiv.style.display = 'block';
        statsDiv.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
            <div style="padding: 1rem; background: var(--bg-subtle); border-radius: 8px;">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">${stats.total_edge_cases}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">è¾¹ç¼˜æ¡ˆä¾‹</div>
            </div>
            <div style="padding: 1rem; background: var(--bg-subtle); border-radius: 8px;">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--warning);">${stats.estimated_code_lines}+</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">ä¼°è®¡ä»£ç è¡Œ</div>
            </div>
            <div style="padding: 1rem; background: var(--bg-subtle); border-radius: 8px;">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--danger);">${stats.low_probability_cases}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">ä½æ¦‚ç‡äº‹ä»¶</div>
            </div>
        </div>
        
        <div class="message info" style="margin-top: 1rem;">
            ${result.lessig_insight.explanation}
        </div>
    `;
    }

    loadScenarios();
</script>
{% endblock %}